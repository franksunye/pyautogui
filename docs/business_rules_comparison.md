# 北京和上海数据处理差异分析

## 文档信息
**文档类型**: 业务分析  
**文档编号**: DOC-ANALYSIS-001  
**版本**: 1.0.0  
**创建日期**: 2025-05-13  
**最后更新**: 2025-05-13  
**状态**: 草稿  
**负责人**: Frank  
**团队成员**: Frank, 小智  

**相关文档**:
- [业务规则参考](./01_business_rules.md)
- [业务对象设计](./02_business_objects_design.md)
- [系统架构概览](./03_system_architecture.md)

## 1. 概述

本文档详细分析了北京和上海数据处理的差异，包括合同金额最大上限规则、奖励计算规则差异和通知内容差异。这些差异对系统的设计和实现有重要影响，需要在代码中正确处理以确保系统的正确性和一致性。

## 2. 合同金额最大上限规则差异

### 2.1 业绩金额上限

| 城市 | 单个合同计入业绩金额上限 | 是否启用业绩金额上限 |
|------|--------------------------|----------------------|
| 北京 | 100,000元                | 是                   |
| 上海 | 40,000元                 | 否（配置为False）    |

**代码实现**:
```python
# 北京配置
PERFORMANCE_AMOUNT_CAP_BJ = 100000
ENABLE_PERFORMANCE_AMOUNT_CAP_BJ = True

# 上海配置
PERFORMANCE_AMOUNT_CAP_SH = 40000
ENABLE_PERFORMANCE_AMOUNT_CAP_SH = False
```

### 2.2 工单金额上限

| 城市 | 单个工单累计合同金额上限 | 说明                                 |
|------|--------------------------|--------------------------------------|
| 北京 | 100,000元                | 同一工单下多个合同的累计金额有上限   |
| 上海 | 无上限                   | 同一工单下多个合同的累计金额没有上限 |

**代码实现**:
```python
# 北京配置
"performance_limits": {
    "single_project_limit": 100000,  # 单个工单金额上限
    "enable_cap": True,
    "single_contract_cap": 100000    # 单个合同金额上限
}

# 上海配置
"performance_limits": {
    "single_project_limit": None,    # 上海没有工单金额上限
    "enable_cap": ENABLE_PERFORMANCE_AMOUNT_CAP_SH,
    "single_contract_cap": PERFORMANCE_AMOUNT_CAP_SH
}
```

### 2.3 业务影响

1. **计入业绩金额计算**:
   - 北京: 如果合同金额超过100,000元，只计入100,000元作为业绩金额
   - 上海: 合同金额全额计入业绩金额（虽然配置了40,000元的上限，但未启用）

2. **工单金额累计**:
   - 北京: 同一工单下的合同金额累计超过100,000元时，超出部分不计入业绩
   - 上海: 同一工单下的合同金额无上限限制，全额计入业绩

## 3. 奖励计算规则差异

### 3.1 幸运数字奖励

| 城市 | 活动月份 | 幸运数字 | 基础幸运奖 | 高额幸运奖 |
|------|----------|----------|------------|------------|
| 北京 | 4月      | 8        | 接好运     | 接好运万元以上 |
| 北京 | 5月      | 6        | 接好运     | 接好运万元以上 |
| 上海 | 4月      | 6        | 接好运     | 接好运万元以上 |
| 上海 | 5月      | 6        | 接好运     | 接好运万元以上 |

**触发条件**:
- 合同编号末位包含指定的幸运数字
- 基础幸运奖: 合同金额 < 10,000元
- 高额幸运奖: 合同金额 ≥ 10,000元

### 3.2 节节高奖励

| 城市 | 最低合同数量 | 奖励等级数量 | 奖励等级 |
|------|--------------|--------------|----------|
| 北京 | 6个          | 3档          | 达标奖、优秀奖、精英奖 |
| 上海 | 5个          | 4档          | 基础奖、达标奖、优秀奖、精英奖 |

**奖励阈值**:
- **北京4月**:
  - 达标奖: 40,000元
  - 优秀奖: 80,000元
  - 精英奖: 120,000元

- **北京5月**:
  - 达标奖: 80,000元
  - 优秀奖: 120,000元
  - 精英奖: 160,000元

- **上海4月和5月**:
  - 基础奖: 40,000元
  - 达标奖: 60,000元
  - 优秀奖: 80,000元
  - 精英奖: 120,000元

### 3.3 奖励金额

| 城市 | 奖励名称 | 奖励金额 |
|------|----------|----------|
| 北京 | 接好运 | 28元 |
| 北京 | 接好运万元以上 | 58元 |
| 北京 | 达标奖 | 200元 |
| 北京 | 优秀奖 | 400元 |
| 北京 | 精英奖 | 600元 |
| 上海 | 接好运 | 36元 |
| 上海 | 接好运万元以上 | 66元 |
| 上海 | 基础奖 | 200元 |
| 上海 | 达标奖 | 300元 |
| 上海 | 优秀奖 | 400元 |
| 上海 | 精英奖 | 800元 |

### 3.4 精英管家特殊规则

| 城市 | 精英管家徽章 | 奖励翻倍 | 说明 |
|------|--------------|----------|------|
| 北京 | 是           | 是，仅节节高奖励 | 精英管家名称前显示徽章，节节高奖励金额翻倍 |
| 上海 | 否           | 否       | 上海技师不参与徽章和奖励翻倍 |

**代码实现**:
```python
# 只有北京的精英管家才能获得奖励翻倍和显示徽章，上海的管家不参与奖励翻倍也不显示徽章
if ENABLE_BADGE_MANAGEMENT and (service_housekeeper in ELITE_HOUSEKEEPER) and city == "BJ":
    # 如果是北京的精英管家，添加徽章
    service_housekeeper = f'{BADGE_NAME}{service_housekeeper}'
    
    # 检查奖励类型，只有节节高奖励才翻倍
    if reward_type == "节节高":
        # 节节高奖励翻倍
        award_info_double = str(int(award_info) * 2)
        award_messages.append(f'达成 {award} 奖励条件，奖励金额 {award_info} 元，同时触发"精英连击双倍奖励"，奖励金额\U0001F680直升至 {award_info_double} 元！\U0001F9E7\U0001F9E7\U0001F9E7')
```

## 4. 通知内容差异

### 4.1 通知格式差异

#### 北京通知格式
```
🧨🧨🧨 签约喜报 🧨🧨🧨
恭喜 {service_housekeeper} 签约合同 {contract_doc_num} 并完成线上收款🎉🎉🎉

🌻 本单为活动期间平台累计签约第 {contract_rank} 单，个人累计签约第 {personal_rank} 单。

🌻 {housekeeper}累计签约 {accumulated_amount} 元[, 累计计入业绩 {performance_amount} 元]

👊 {next_msg}。
```

#### 上海通知格式
```
🧨🧨🧨 签约喜报 🧨🧨🧨
恭喜 {housekeeper} 签约合同 {contract_doc_num} 并完成线上收款🎉🎉🎉

🌻 本单为本月平台累计签约第 {contract_rank} 单，个人累计签约第 {personal_rank} 单，

🌻 {housekeeper}累计签约 {accumulated_amount} 元，

🌻 转化率 {conversion_rate}。

👊 {next_msg}。
```

### 4.2 主要差异

1. **徽章显示**:
   - 北京: 精英管家名称前显示徽章（如"🏆张三"）
   - 上海: 不显示徽章

2. **累计业绩显示**:
   - 北京: 如果启用业绩金额上限，显示"累计计入业绩"字段
   - 上海: 不显示"累计计入业绩"字段

3. **转化率显示**:
   - 北京: 不显示转化率
   - 上海: 显示转化率

4. **文本格式**:
   - 北京: 使用更紧凑的格式，每个信息点占一行
   - 上海: 使用更分散的格式，部分信息点合并在一行

### 4.3 奖励通知差异

#### 北京精英管家奖励通知（节节高奖励）
```
{housekeeper}签约合同{contract_number}

达成 {award} 奖励条件，奖励金额 {award_info} 元，同时触发"精英连击双倍奖励"，奖励金额🚀直升至 {award_info_double} 元！🧧🧧🧧
```

#### 普通奖励通知
```
{housekeeper}签约合同{contract_number}

达成{award}奖励条件，获得签约奖励{award_info}元 🧧🧧🧧
```

## 5. 总结

### 5.1 关键差异点

1. **业绩计算规则**:
   - 北京启用了合同金额上限和工单金额上限
   - 上海没有启用这些上限

2. **奖励等级结构**:
   - 北京: 6个合同起，3档奖励
   - 上海: 5个合同起，4档奖励

3. **精英管家特殊处理**:
   - 北京: 精英管家显示徽章，节节高奖励翻倍
   - 上海: 不使用精英管家功能

4. **通知内容**:
   - 北京: 不显示转化率，可能显示计入业绩金额
   - 上海: 显示转化率，不显示计入业绩金额

### 5.2 代码实现建议

1. **使用统一配置结构**:
   ```python
   CAMPAIGN_CONFIGS = {
       "BJ-2025-05": {
           "reward": { ... },
           "notification": { ... },
           "data_source": { ... }
       },
       "SH-2025-05": {
           "reward": { ... },
           "notification": { ... },
           "data_source": { ... }
       }
   }
   ```

2. **使用通用处理函数**:
   ```python
   def determine_rewards_generic(contract_number, housekeeper_data, current_contract_amount, config_key):
       # 通用奖励计算逻辑
       pass
   ```

3. **使用模板函数处理通知差异**:
   ```python
   def format_contract_signing_message(housekeeper, contract_doc_num, contract_amount, 
                                      conversion_rate, accumulated_amount, next_reward_msg,
                                      city="BJ"):
       # 根据城市选择不同的通知模板
       pass
   ```
