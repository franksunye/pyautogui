# 业务规则参考

## 文档信息
**文档类型**: 业务规则
**文档编号**: DOC-RULES-001
**版本**: 1.2.0
**创建日期**: 2025-04-29
**最后更新**: 2025-05-13
**状态**: 已更新
**负责人**: Frank
**团队成员**: Frank, 小智

**相关文档**:
- [业务对象设计](./02_business_objects_design.md)
- [系统架构概览](./03_system_architecture.md)
- [版本管理规范](./07_version_management.md)

## 1. 奖励计算规则

### 1.1 幸运数字奖励
- **触发条件**: 合同编号末位包含指定的幸运数字
- **奖励等级**:
  - **基础幸运奖**: 合同金额 < 10,000元
  - **高额幸运奖**: 合同金额 ≥ 10,000元
- **城市差异**:
  - **北京4月**: 幸运数字为"8"
  - **北京5月**: 幸运数字为"6"
  - **上海4月**: 幸运数字为"6"
  - **上海5月**: 幸运数字为"6"

**奖励金额**:
| 城市 | 奖励名称 | 奖励金额 |
|------|----------|----------|
| 北京 | 接好运 | 28元 |
| 北京 | 接好运万元以上 | 58元 |
| 上海 | 接好运 | 36元 |
| 上海 | 接好运万元以上 | 66元 |

### 1.2 节节高奖励
- **基本条件**: 管家累计合同数量达到最低要求
- **奖励等级**: 根据管家累计业绩金额确定
- **城市差异**:
  - **北京**: 最低需要6个合同，三档奖励(达标奖、优秀奖、精英奖)
  - **上海**: 最低需要5个合同，四档奖励(基础奖、达标奖、优秀奖、精英奖)

**奖励金额**:
| 城市 | 奖励名称 | 奖励金额 |
|------|----------|----------|
| 北京 | 达标奖 | 200元 |
| 北京 | 优秀奖 | 400元 |
| 北京 | 精英奖 | 600元 |
| 上海 | 基础奖 | 200元 |
| 上海 | 达标奖 | 300元 |
| 上海 | 优秀奖 | 400元 |
| 上海 | 精英奖 | 800元 |

### 1.3 奖励阈值
- **北京4月**:
  - 达标奖: 40,000元
  - 优秀奖: 80,000元
  - 精英奖: 120,000元

- **北京5月**:
  - 达标奖: 80,000元
  - 优秀奖: 120,000元
  - 精英奖: 160,000元

- **上海4月和5月**:
  - 基础奖: 40,000元
  - 达标奖: 60,000元
  - 优秀奖: 80,000元
  - 精英奖: 120,000元

### 1.4 自动发放规则
- 当管家累计业绩达到高级别奖励阈值时，自动发放所有低级别奖励
- 例如: 达到精英奖标准时，自动发放达标奖和优秀奖
- 系统会记录已发放的奖励，避免重复发放

### 1.5 业绩金额计算
- **业绩金额上限**:
  - **北京**: 单个合同计入业绩金额上限为100,000元，已启用
  - **上海**: 单个合同计入业绩金额上限为40,000元，未启用
- **工单金额上限**:
  - **北京**: 单个工单累计合同金额上限为100,000元
  - **上海**: 无工单金额上限

### 1.6 奖金池计算
- 奖金池 = 合同金额 × 奖金池计算比例
- 奖金池计算比例为0.2% (0.002)
- 两个城市使用相同的奖金池计算比例

## 2. 业务术语定义

### 2.1 核心术语
- **管家**: 负责客户服务和合同签约的服务人员
- **节节高**: 基于累计业绩的阶梯式奖励机制
- **幸运数字**: 触发特殊奖励的合同编号末位数字
- **工单**: 服务请求单，一个工单可能对应多个合同
- **合同**: 客户签约的服务协议，包含金额和服务内容
- **业绩金额**: 计入奖励计算的合同金额，可能有上限限制
- **奖金池**: 用于发放奖励的资金池，基于合同金额计算
- **合同计数器**: 记录活动期内处理的合同数量，用于幸运奖励计算

### 2.2 奖励类型
- **接好运**: 基础幸运数字奖励，合同金额小于1万元
- **接好运万元以上**: 高额幸运数字奖励，合同金额1万元以上
- **基础奖**: 上海节节高第一级奖励
- **达标奖**: 节节高第一级奖励(北京)/第二级奖励(上海)
- **优秀奖**: 节节高第二级奖励(北京)/第三级奖励(上海)
- **精英奖**: 节节高最高级奖励

## 3. 特殊情况处理

### 3.1 重复合同处理
- 系统会检测并跳过重复的合同ID
- 重复合同不计入管家业绩和合同数量
- 检测方式：`if contract_id in processed_contract_ids`

### 3.2 已存在合同处理
- 已存在于历史记录中的合同ID会被跳过
- 已存在合同不会触发新的奖励通知
- 检测方式：`if contract_id in existing_contract_ids`
- 文件模式和数据库模式使用相同的逻辑处理已存在合同

### 3.3 管家奖励记录
- 系统维护每个管家已获得的奖励记录
- 已获得的奖励不会重复发放
- 记录方式：`housekeeper_data.setdefault('awarded', []).append(tier_name)`

### 3.4 精英管家特殊规则
- **北京**:
  - 特定管家(如胡林波、余金凤等)被标记为精英管家
  - 精英管家在通知中会显示特殊徽章（如"🏆张三"）
  - 精英管家的节节高奖励金额翻倍（幸运数字奖励不翻倍）
- **上海**:
  - 上海技师不参与徽章和奖励翻倍
  - 上海技师的通知中不显示徽章

### 3.5 服务商映射
- 系统维护服务商名称到接收人名称的映射
- 通知会发送给映射表中指定的接收人

## 4. 通知内容差异

### 4.1 北京通知格式
```
🧨🧨🧨 签约喜报 🧨🧨🧨
恭喜 {service_housekeeper} 签约合同 {contract_doc_num} 并完成线上收款🎉🎉🎉

🌻 本单为活动期间平台累计签约第 {contract_rank} 单，个人累计签约第 {personal_rank} 单。

🌻 {housekeeper}累计签约 {accumulated_amount} 元[, 累计计入业绩 {performance_amount} 元]

👊 {next_msg}。
```

### 4.2 上海通知格式
```
🧨🧨🧨 签约喜报 🧨🧨🧨
恭喜 {housekeeper} 签约合同 {contract_doc_num} 并完成线上收款🎉🎉🎉

🌻 本单为本月平台累计签约第 {contract_rank} 单，个人累计签约第 {personal_rank} 单，

🌻 {housekeeper}累计签约 {accumulated_amount} 元，

🌻 转化率 {conversion_rate}。

👊 {next_msg}。
```

### 4.3 主要差异
1. **徽章显示**: 北京精英管家显示徽章，上海不显示
2. **累计业绩显示**: 北京可能显示"累计计入业绩"，上海不显示
3. **转化率显示**: 北京不显示转化率，上海显示
4. **文本格式**: 北京更紧凑，上海更分散

## 5. 北京和上海数据处理差异详细分析

### 5.1 概述

北京和上海数据处理存在多项差异，包括合同金额最大上限规则、奖励计算规则差异和通知内容差异。这些差异对系统的设计和实现有重要影响，需要在代码中正确处理以确保系统的正确性和一致性。

### 5.2 合同金额最大上限规则差异

#### 5.2.1 业绩金额上限

| 城市 | 单个合同计入业绩金额上限 | 是否启用业绩金额上限 |
|------|--------------------------|----------------------|
| 北京 | 100,000元                | 是                   |
| 上海 | 40,000元                 | 否（配置为False）    |

**代码实现**:
```python
# 北京配置
PERFORMANCE_AMOUNT_CAP_BJ = 100000
ENABLE_PERFORMANCE_AMOUNT_CAP_BJ = True

# 上海配置
PERFORMANCE_AMOUNT_CAP_SH = 40000
ENABLE_PERFORMANCE_AMOUNT_CAP_SH = False
```

#### 5.2.2 工单金额上限

| 城市 | 单个工单累计合同金额上限 | 说明                                 |
|------|--------------------------|--------------------------------------|
| 北京 | 100,000元                | 同一工单下多个合同的累计金额有上限   |
| 上海 | 无上限                   | 同一工单下多个合同的累计金额没有上限 |

**代码实现**:
```python
# 北京配置
"performance_limits": {
    "single_project_limit": 100000,  # 单个工单金额上限
    "enable_cap": True,
    "single_contract_cap": 100000    # 单个合同金额上限
}

# 上海配置
"performance_limits": {
    "single_project_limit": None,    # 上海没有工单金额上限
    "enable_cap": ENABLE_PERFORMANCE_AMOUNT_CAP_SH,
    "single_contract_cap": PERFORMANCE_AMOUNT_CAP_SH
}
```

#### 5.2.3 业务影响

1. **计入业绩金额计算**:
   - 北京: 如果合同金额超过100,000元，只计入100,000元作为业绩金额
   - 上海: 合同金额全额计入业绩金额（虽然配置了40,000元的上限，但未启用）

2. **工单金额累计**:
   - 北京: 同一工单下的合同金额累计超过100,000元时，超出部分不计入业绩
   - 上海: 同一工单下的合同金额无上限限制，全额计入业绩

### 5.3 精英管家特殊规则详细说明

| 城市 | 精英管家徽章 | 奖励翻倍 | 说明 |
|------|--------------|----------|------|
| 北京 | 是           | 是，仅节节高奖励 | 精英管家名称前显示徽章，节节高奖励金额翻倍 |
| 上海 | 否           | 否       | 上海技师不参与徽章和奖励翻倍 |

**代码实现**:
```python
# 只有北京的精英管家才能获得奖励翻倍和显示徽章，上海的管家不参与奖励翻倍也不显示徽章
if ENABLE_BADGE_MANAGEMENT and (service_housekeeper in ELITE_HOUSEKEEPER) and city == "BJ":
    # 如果是北京的精英管家，添加徽章
    service_housekeeper = f'{BADGE_NAME}{service_housekeeper}'

    # 检查奖励类型，只有节节高奖励才翻倍
    if reward_type == "节节高":
        # 节节高奖励翻倍
        award_info_double = str(int(award_info) * 2)
        award_messages.append(f'达成 {award} 奖励条件，奖励金额 {award_info} 元，同时触发"精英连击双倍奖励"，奖励金额🚀直升至 {award_info_double} 元！🧧🧧🧧')
```

### 5.4 奖励通知差异详细说明

#### 5.4.1 北京精英管家奖励通知（节节高奖励）
```
{housekeeper}签约合同{contract_number}

达成 {award} 奖励条件，奖励金额 {award_info} 元，同时触发"精英连击双倍奖励"，奖励金额🚀直升至 {award_info_double} 元！🧧🧧🧧
```

#### 5.4.2 普通奖励通知
```
{housekeeper}签约合同{contract_number}

达成{award}奖励条件，获得签约奖励{award_info}元 🧧🧧🧧
```

### 5.5 代码实现建议

1. **使用统一配置结构**:
   ```python
   CAMPAIGN_CONFIGS = {
       "BJ-2025-05": {
           "reward": { ... },
           "notification": { ... },
           "data_source": { ... }
       },
       "SH-2025-05": {
           "reward": { ... },
           "notification": { ... },
           "data_source": { ... }
       }
   }
   ```

2. **使用通用处理函数**:
   ```python
   def determine_rewards_generic(contract_number, housekeeper_data, current_contract_amount, config_key):
       # 通用奖励计算逻辑
       pass
   ```

3. **使用模板函数处理通知差异**:
   ```python
   def format_contract_signing_message(housekeeper, contract_doc_num, contract_amount,
                                      conversion_rate, accumulated_amount, next_reward_msg,
                                      city="BJ"):
       # 根据城市选择不同的通知模板
       pass
   ```

## 6. 当前业务重点

当前重构工作中，需要特别关注:

1. 确保通用数据处理函数正确处理北京和上海的所有业务规则差异
2. 保持奖励计算逻辑的一致性，特别是在处理边界情况时
3. 正确应用性能上限和工单金额上限规则
4. 确保自动发放低级别奖励的逻辑在所有场景下正确工作
5. 确保文件模式和数据库模式下合同计数器逻辑完全一致
6. 确保通知内容格式在两种模式下保持一致

## 更新记录

| 版本 | 日期 | 更新者 | 更新内容 |
|------|------|--------|----------|
| 1.0.0 | 2025-04-29 | 小智 | 初始版本 |
| 1.1.0 | 2025-05-13 | Frank | 添加北京和上海差异详细分析，更新通知内容差异 |
| 1.2.0 | 2025-05-13 | Frank | 合并北京和上海数据处理差异分析文档，添加详细代码实现示例和建议 |
