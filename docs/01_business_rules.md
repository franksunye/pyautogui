# 业务规则参考

## 文档信息
**文档类型**: 业务规则
**文档编号**: DOC-RULES-001
**版本**: 1.1.0
**创建日期**: 2025-04-29
**最后更新**: 2025-05-13
**状态**: 已更新
**负责人**: Frank
**团队成员**: Frank, 小智

**相关文档**:
- [北京和上海数据处理差异分析](./business_rules_comparison.md)
- [业务对象设计](./02_business_objects_design.md)
- [系统架构概览](./03_system_architecture.md)

## 1. 奖励计算规则

### 1.1 幸运数字奖励
- **触发条件**: 合同编号末位包含指定的幸运数字
- **奖励等级**:
  - **基础幸运奖**: 合同金额 < 10,000元
  - **高额幸运奖**: 合同金额 ≥ 10,000元
- **城市差异**:
  - **北京4月**: 幸运数字为"8"
  - **北京5月**: 幸运数字为"6"
  - **上海4月**: 幸运数字为"6"
  - **上海5月**: 幸运数字为"6"

**奖励金额**:
| 城市 | 奖励名称 | 奖励金额 |
|------|----------|----------|
| 北京 | 接好运 | 28元 |
| 北京 | 接好运万元以上 | 58元 |
| 上海 | 接好运 | 36元 |
| 上海 | 接好运万元以上 | 66元 |

### 1.2 节节高奖励
- **基本条件**: 管家累计合同数量达到最低要求
- **奖励等级**: 根据管家累计业绩金额确定
- **城市差异**:
  - **北京**: 最低需要6个合同，三档奖励(达标奖、优秀奖、精英奖)
  - **上海**: 最低需要5个合同，四档奖励(基础奖、达标奖、优秀奖、精英奖)

**奖励金额**:
| 城市 | 奖励名称 | 奖励金额 |
|------|----------|----------|
| 北京 | 达标奖 | 200元 |
| 北京 | 优秀奖 | 400元 |
| 北京 | 精英奖 | 600元 |
| 上海 | 基础奖 | 200元 |
| 上海 | 达标奖 | 300元 |
| 上海 | 优秀奖 | 400元 |
| 上海 | 精英奖 | 800元 |

### 1.3 奖励阈值
- **北京4月**:
  - 达标奖: 40,000元
  - 优秀奖: 80,000元
  - 精英奖: 120,000元

- **北京5月**:
  - 达标奖: 80,000元
  - 优秀奖: 120,000元
  - 精英奖: 160,000元

- **上海4月和5月**:
  - 基础奖: 40,000元
  - 达标奖: 60,000元
  - 优秀奖: 80,000元
  - 精英奖: 120,000元

### 1.4 自动发放规则
- 当管家累计业绩达到高级别奖励阈值时，自动发放所有低级别奖励
- 例如: 达到精英奖标准时，自动发放达标奖和优秀奖
- 系统会记录已发放的奖励，避免重复发放

### 1.5 业绩金额计算
- **业绩金额上限**:
  - **北京**: 单个合同计入业绩金额上限为100,000元，已启用
  - **上海**: 单个合同计入业绩金额上限为40,000元，未启用
- **工单金额上限**:
  - **北京**: 单个工单累计合同金额上限为100,000元
  - **上海**: 无工单金额上限

### 1.6 奖金池计算
- 奖金池 = 合同金额 × 奖金池计算比例
- 奖金池计算比例为0.2% (0.002)
- 两个城市使用相同的奖金池计算比例

## 2. 业务术语定义

### 2.1 核心术语
- **管家**: 负责客户服务和合同签约的服务人员
- **节节高**: 基于累计业绩的阶梯式奖励机制
- **幸运数字**: 触发特殊奖励的合同编号末位数字
- **工单**: 服务请求单，一个工单可能对应多个合同
- **合同**: 客户签约的服务协议，包含金额和服务内容
- **业绩金额**: 计入奖励计算的合同金额，可能有上限限制
- **奖金池**: 用于发放奖励的资金池，基于合同金额计算
- **合同计数器**: 记录活动期内处理的合同数量，用于幸运奖励计算

### 2.2 奖励类型
- **接好运**: 基础幸运数字奖励，合同金额小于1万元
- **接好运万元以上**: 高额幸运数字奖励，合同金额1万元以上
- **基础奖**: 上海节节高第一级奖励
- **达标奖**: 节节高第一级奖励(北京)/第二级奖励(上海)
- **优秀奖**: 节节高第二级奖励(北京)/第三级奖励(上海)
- **精英奖**: 节节高最高级奖励

## 3. 特殊情况处理

### 3.1 重复合同处理
- 系统会检测并跳过重复的合同ID
- 重复合同不计入管家业绩和合同数量
- 检测方式：`if contract_id in processed_contract_ids`

### 3.2 已存在合同处理
- 已存在于历史记录中的合同ID会被跳过
- 已存在合同不会触发新的奖励通知
- 检测方式：`if contract_id in existing_contract_ids`
- 文件模式和数据库模式使用相同的逻辑处理已存在合同

### 3.3 管家奖励记录
- 系统维护每个管家已获得的奖励记录
- 已获得的奖励不会重复发放
- 记录方式：`housekeeper_data.setdefault('awarded', []).append(tier_name)`

### 3.4 精英管家特殊规则
- **北京**:
  - 特定管家(如胡林波、余金凤等)被标记为精英管家
  - 精英管家在通知中会显示特殊徽章（如"🏆张三"）
  - 精英管家的节节高奖励金额翻倍（幸运数字奖励不翻倍）
- **上海**:
  - 上海技师不参与徽章和奖励翻倍
  - 上海技师的通知中不显示徽章

### 3.5 服务商映射
- 系统维护服务商名称到接收人名称的映射
- 通知会发送给映射表中指定的接收人

## 4. 通知内容差异

### 4.1 北京通知格式
```
🧨🧨🧨 签约喜报 🧨🧨🧨
恭喜 {service_housekeeper} 签约合同 {contract_doc_num} 并完成线上收款🎉🎉🎉

🌻 本单为活动期间平台累计签约第 {contract_rank} 单，个人累计签约第 {personal_rank} 单。

🌻 {housekeeper}累计签约 {accumulated_amount} 元[, 累计计入业绩 {performance_amount} 元]

👊 {next_msg}。
```

### 4.2 上海通知格式
```
🧨🧨🧨 签约喜报 🧨🧨🧨
恭喜 {housekeeper} 签约合同 {contract_doc_num} 并完成线上收款🎉🎉🎉

🌻 本单为本月平台累计签约第 {contract_rank} 单，个人累计签约第 {personal_rank} 单，

🌻 {housekeeper}累计签约 {accumulated_amount} 元，

🌻 转化率 {conversion_rate}。

👊 {next_msg}。
```

### 4.3 主要差异
1. **徽章显示**: 北京精英管家显示徽章，上海不显示
2. **累计业绩显示**: 北京可能显示"累计计入业绩"，上海不显示
3. **转化率显示**: 北京不显示转化率，上海显示
4. **文本格式**: 北京更紧凑，上海更分散

## 5. 当前业务重点

当前重构工作中，需要特别关注:

1. 确保通用数据处理函数正确处理北京和上海的所有业务规则差异
2. 保持奖励计算逻辑的一致性，特别是在处理边界情况时
3. 正确应用性能上限和工单金额上限规则
4. 确保自动发放低级别奖励的逻辑在所有场景下正确工作
5. 确保文件模式和数据库模式下合同计数器逻辑完全一致
6. 确保通知内容格式在两种模式下保持一致

## 更新记录

| 版本 | 日期 | 更新者 | 更新内容 |
|------|------|--------|----------|
| 1.0.0 | 2025-04-29 | 小智 | 初始版本 |
| 1.1.0 | 2025-05-13 | Frank | 添加北京和上海差异详细分析，更新通知内容差异 |
