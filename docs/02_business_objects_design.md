# 业务对象设计

## 概述

本文档通过业务分析，从现有代码中提炼出隐含的业务对象设计。虽然当前项目采用函数式编程方法实现，但面向对象的设计思路对项目升级和重构具有重要指导意义。

## 核心业务对象

### 1. 活动(Campaign)

**描述**: 表示一个销售激励活动，具有特定的时间范围、地区和奖励规则。

**属性**:
- 活动ID: 如 "BJ-2025-04"（北京2025年4月活动）
- 活动城市: 如 "北京"、"上海"
- 活动时间: 开始日期和结束日期
- 幸运数字: 触发幸运数字奖励的数字
- 奖励规则: 包括幸运数字奖励和节节高奖励的规则
- 性能上限配置: 单个合同计入业绩金额的上限

**行为**:
- 初始化活动
- 获取活动数据
- 处理活动数据
- 发送活动通知

### 2. 合同(Contract)

**描述**: 表示一个销售合同，包含合同基本信息和计算奖励所需的数据。

**属性**:
- 合同ID: 唯一标识符
- 管家: 负责该合同的服务管家
- 合同金额: 合同的总金额
- 支付金额: 已支付的金额
- 签约时间: 合同签约的日期
- 合同状态: 如 "active"、"cancelled"
- 工单编号: 关联的服务工单编号
- 服务商: 提供服务的机构

**行为**:
- 计算计入业绩的金额
- 检查是否符合奖励条件
- 获取合同详情

### 3. 奖励(Reward)

**描述**: 表示一个奖励项，包含奖励类型、名称和消息。

**属性**:
- 奖励类型: 如 "lucky"（幸运数字）、"progressive"（节节高）
- 奖励名称: 如 "接好运"、"优秀奖"
- 奖励消息: 发送给管家的通知消息
- 关联合同: 触发该奖励的合同
- 关联管家: 获得该奖励的管家

**行为**:
- 生成奖励消息
- 检查奖励条件
- 记录奖励信息

### 4. 管家(Housekeeper)

**描述**: 表示一个服务管家，负责签约和服务。

**属性**:
- 管家姓名: 如 "张三"
- 管家ID: 唯一标识符
- 累计合同数: 在活动期内签约的合同数量
- 累计业绩金额: 在活动期内的总业绩金额
- 获得的奖励: 管家获得的所有奖励

**行为**:
- 计算累计业绩
- 检查奖励资格
- 接收奖励通知

### 5. 通知(Notification)

**描述**: 表示一个发送给管家的通知，包含奖励信息。

**属性**:
- 通知ID: 唯一标识符
- 通知类型: 如 "奖励通知"、"提醒通知"
- 通知内容: 发送的具体消息
- 接收者: 通知的接收管家
- 发送状态: 如 "已发送"、"未发送"
- 发送时间: 通知发送的时间

**行为**:
- 生成通知内容
- 发送通知
- 更新发送状态
- 记录发送历史

## 业务对象关系

1. **活动-合同**: 一个活动包含多个合同，一个合同属于一个活动。
2. **合同-管家**: 一个合同由一个管家负责，一个管家可以负责多个合同。
3. **活动-奖励**: 一个活动定义了多种奖励，一种奖励属于一个活动。
4. **管家-奖励**: 一个管家可以获得多个奖励，一个奖励授予一个管家。
5. **奖励-通知**: 一个奖励触发一个通知，一个通知包含一个奖励信息。
6. **管家-通知**: 一个管家可以接收多个通知，一个通知发送给一个管家。

## 业务流程

1. **初始化活动**:
   - 设置活动参数（城市、时间、奖励规则等）
   - 准备数据存储和通知渠道

2. **数据获取与处理**:
   - 从Metabase获取合同数据
   - 过滤和转换数据
   - 计算管家累计业绩

3. **奖励计算**:
   - 检查合同是否符合幸运数字奖励条件
   - 检查管家是否达到节节高奖励条件
   - 生成奖励记录

4. **通知发送**:
   - 生成奖励通知内容
   - 发送通知到企业微信
   - 更新通知状态

5. **数据记录与统计**:
   - 记录已处理的合同
   - 记录已发送的通知
   - 统计奖励分布情况

## 实现考虑

虽然当前项目采用函数式编程方法实现，但可以考虑以下改进：

1. **引入类结构**:
   - 将上述业务对象实现为类
   - 使用继承和组合简化代码

2. **数据持久化**:
   - 使用SQLite存储业务对象数据
   - 实现对象关系映射

3. **接口设计**:
   - 为每个业务对象定义清晰的接口
   - 降低组件间耦合

4. **配置管理**:
   - 将活动参数和奖励规则外部化配置
   - 支持动态加载不同活动配置

## 结论

通过面向对象的设计思路分析现有系统，可以更清晰地理解业务逻辑和数据流，为后续的系统升级和重构提供指导。虽然当前实现采用函数式方法，但引入面向对象的概念可以提高代码的可维护性和可扩展性。
