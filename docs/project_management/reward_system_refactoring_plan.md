# 奖励系统重构计划

**文档状态**: 草稿  
**创建日期**: 2025-04-29  
**最后更新**: 2025-04-29  
**负责人**: [待定]  
**文档版本**: 1.0

## 1. 项目概述

### 1.1 背景

当前的奖励系统中，北京和上海的数据处理函数采用了不同的实现方式。北京已经使用了通用奖励确定函数，而上海仍然使用特定的奖励确定函数。这种不一致性增加了维护成本，并可能导致功能差异。

### 1.2 目标

1. 统一北京和上海的数据处理函数，创建一个通用的数据处理框架
2. 确保新实现与原始实现功能完全一致
3. 提高代码可维护性和可扩展性
4. 在整个过程中保持系统稳定运行

### 1.3 范围

- 重构 `process_data_apr_beijing` 和 `process_data_shanghai_apr` 函数
- 创建通用数据处理函数 `process_data_generic`
- 添加上海的配置到 `REWARD_CONFIGS` 字典
- 创建上海的通用奖励确定函数包装函数
- 添加必要的测试和文档

### 1.4 非范围

- 不修改现有的业务逻辑和奖励规则
- 不修改通知模块和其他系统组件
- 不修改用户界面或API

## 2. 实施计划

### 2.1 第一阶段：准备工作（1-2周）

#### 2.1.1 添加上海的配置到 REWARD_CONFIGS

- **任务**: 在 `config.py` 中为上海添加配置项
- **详情**: 添加 "SH-2025-04" 和 "SH-2025-05" 配置，确保与现有的上海奖励规则一致
- **验收标准**: 配置项已添加并通过代码审查
- **状态**: 未开始
- **负责人**: [待定]
- **截止日期**: [待定]

#### 2.1.2 创建上海的通用奖励确定函数包装函数

- **任务**: 实现 `determine_rewards_apr_shanghai_generic` 和 `determine_rewards_may_shanghai_generic`
- **详情**: 这些函数调用通用函数 `determine_rewards_generic` 并传入相应的配置键
- **验收标准**: 函数已实现并通过单元测试
- **状态**: 未开始
- **负责人**: [待定]
- **截止日期**: [待定]

#### 2.1.3 添加单元测试

- **任务**: 为新添加的函数创建单元测试
- **详情**: 确保测试覆盖所有边界情况和特殊场景
- **验收标准**: 测试已实现并通过
- **状态**: 未开始
- **负责人**: [待定]
- **截止日期**: [待定]

### 2.2 第二阶段：实现通用数据处理函数（2-3周）

#### 2.2.1 创建通用数据处理函数

- **任务**: 实现 `process_data_generic` 函数
- **详情**: 支持所有现有功能，处理北京和上海的所有差异，添加详细的文档和注释
- **验收标准**: 函数已实现并通过代码审查
- **状态**: 未开始
- **负责人**: [待定]
- **截止日期**: [待定]

#### 2.2.2 添加功能标志

- **任务**: 在 `config.py` 中添加功能标志
- **详情**: 添加 `USE_GENERIC_PROCESS_FUNCTION = False` 标志，允许在运行时控制是否使用新函数
- **验收标准**: 功能标志已添加并通过代码审查
- **状态**: 未开始
- **负责人**: [待定]
- **截止日期**: [待定]

#### 2.2.3 创建包装函数

- **任务**: 实现 `process_data_apr_beijing_generic` 和 `process_data_shanghai_apr_generic`
- **详情**: 这些函数调用通用函数并传入相应的参数
- **验收标准**: 函数已实现并通过代码审查
- **状态**: 未开始
- **负责人**: [待定]
- **截止日期**: [待定]

### 2.3 第三阶段：并行运行和验证（2-4周）

#### 2.3.1 修改现有的处理函数

- **任务**: 在 `process_data_apr_beijing` 和 `process_data_shanghai_apr` 中添加并行运行逻辑
- **详情**: 同时调用原始逻辑和新逻辑，但只返回原始结果，添加日志记录比较两种方法的结果
- **验收标准**: 修改已完成并通过代码审查
- **状态**: 未开始
- **负责人**: [待定]
- **截止日期**: [待定]

#### 2.3.2 添加结果比较函数

- **任务**: 实现 `compare_results` 函数
- **详情**: 详细比较两种方法的结果，记录任何差异
- **验收标准**: 函数已实现并通过代码审查
- **状态**: 未开始
- **负责人**: [待定]
- **截止日期**: [待定]

#### 2.3.3 在测试环境中启用功能标志

- **任务**: 在测试环境中设置 `USE_GENERIC_PROCESS_FUNCTION = True`
- **详情**: 收集并分析比较结果，确保新实现与原始实现一致
- **验收标准**: 测试完成，结果一致或差异已解决
- **状态**: 未开始
- **负责人**: [待定]
- **截止日期**: [待定]

### 2.4 第四阶段：切换到新实现（1-2周）

#### 2.4.1 修改包装函数

- **任务**: 更新 `process_data_apr_beijing` 和 `process_data_shanghai_apr` 以使用新逻辑
- **详情**: 根据功能标志选择使用新逻辑或原始逻辑
- **验收标准**: 修改已完成并通过代码审查
- **状态**: 未开始
- **负责人**: [待定]
- **截止日期**: [待定]

#### 2.4.2 在生产环境中启用功能标志

- **任务**: 在生产环境中设置 `USE_GENERIC_PROCESS_FUNCTION = True`
- **详情**: 监控系统，确保一切正常运行
- **验收标准**: 功能标志已启用，系统运行正常
- **状态**: 未开始
- **负责人**: [待定]
- **截止日期**: [待定]

#### 2.4.3 添加监控和警报

- **任务**: 实现监控机制，设置警报
- **详情**: 检测新实现的任何问题，在出现问题时通知团队
- **验收标准**: 监控和警报已设置并测试
- **状态**: 未开始
- **负责人**: [待定]
- **截止日期**: [待定]

### 2.5 第五阶段：清理和完成（1-2周）

#### 2.5.1 移除原始实现

- **任务**: 一旦确认新实现稳定可靠，移除原始逻辑
- **详情**: 保留包装函数，以维持向后兼容性
- **验收标准**: 原始逻辑已移除，系统运行正常
- **状态**: 未开始
- **负责人**: [待定]
- **截止日期**: [待定]

#### 2.5.2 移除功能标志

- **任务**: 移除 `USE_GENERIC_PROCESS_FUNCTION` 标志
- **详情**: 直接使用新实现
- **验收标准**: 功能标志已移除，系统运行正常
- **状态**: 未开始
- **负责人**: [待定]
- **截止日期**: [待定]

#### 2.5.3 更新文档

- **任务**: 更新所有相关文档
- **详情**: 反映新的实现，提供迁移指南
- **验收标准**: 文档已更新并通过审查
- **状态**: 未开始
- **负责人**: [待定]
- **截止日期**: [待定]

#### 2.5.4 代码审查和最终测试

- **任务**: 进行全面的代码审查和测试
- **详情**: 运行完整的测试套件，确保一切正常
- **验收标准**: 代码审查和测试已完成，无问题
- **状态**: 未开始
- **负责人**: [待定]
- **截止日期**: [待定]

## 3. 风险和缓解措施

### 3.1 功能差异风险

- **风险**: 新实现可能与原始实现有细微差异
- **影响**: 高
- **可能性**: 中
- **缓解措施**: 详细的比较逻辑和全面的测试
- **触发条件**: 发现任何功能差异
- **应急计划**: 回滚到原始实现，修复差异后重新部署

### 3.2 性能风险

- **风险**: 通用函数可能比专用函数慢
- **影响**: 中
- **可能性**: 低
- **缓解措施**: 性能测试和优化
- **触发条件**: 性能下降超过10%
- **应急计划**: 优化通用函数，必要时回滚

### 3.3 回滚风险

- **风险**: 如果新实现有问题，可能难以回滚
- **影响**: 高
- **可能性**: 低
- **缓解措施**: 功能标志和保留原始逻辑作为后备
- **触发条件**: 需要回滚但遇到困难
- **应急计划**: 使用功能标志立即切换回原始实现

### 3.4 团队协作风险

- **风险**: 团队成员可能不熟悉新实现
- **影响**: 中
- **可能性**: 中
- **缓解措施**: 详细文档和知识分享会议
- **触发条件**: 团队成员反馈理解困难
- **应急计划**: 增加培训和文档，安排一对一辅导

## 4. 依赖关系

### 4.1 内部依赖

- 完成第一阶段后才能开始第二阶段
- 完成第二阶段后才能开始第三阶段
- 完成第三阶段后才能开始第四阶段
- 完成第四阶段后才能开始第五阶段

### 4.2 外部依赖

- 需要测试环境可用性
- 需要团队成员的时间和资源
- 需要代码审查和测试资源

## 5. 资源需求

### 5.1 人力资源

- 开发人员: 1-2人
- 测试人员: 1人
- 代码审查人员: 1-2人
- 项目管理: 1人

### 5.2 环境资源

- 开发环境
- 测试环境
- 生产环境

## 6. 沟通计划

### 6.1 定期会议

- 每周进度会议
- 每阶段结束后的评审会议
- 需要时的临时会议

### 6.2 报告和文档

- 每周进度报告
- 每阶段结束报告
- 最终项目总结报告

## 7. 验收标准

### 7.1 功能验收

- 新实现与原始实现功能完全一致
- 所有测试用例通过
- 没有新的错误或警告

### 7.2 性能验收

- 性能不低于原始实现
- 响应时间在可接受范围内
- 资源使用在可接受范围内

### 7.3 代码质量验收

- 代码符合项目编码标准
- 代码审查通过
- 文档完整且准确

## 8. 项目时间线

| 阶段 | 开始日期 | 结束日期 | 持续时间 | 状态 |
|------|----------|----------|----------|------|
| 第一阶段：准备工作 | [待定] | [待定] | 1-2周 | 未开始 |
| 第二阶段：实现通用数据处理函数 | [待定] | [待定] | 2-3周 | 未开始 |
| 第三阶段：并行运行和验证 | [待定] | [待定] | 2-4周 | 未开始 |
| 第四阶段：切换到新实现 | [待定] | [待定] | 1-2周 | 未开始 |
| 第五阶段：清理和完成 | [待定] | [待定] | 1-2周 | 未开始 |
| 总计 | [待定] | [待定] | 7-13周 | 未开始 |

## 9. 进度跟踪

| 日期 | 完成的任务 | 遇到的问题 | 解决方案 | 下一步计划 |
|------|------------|------------|----------|------------|
| 2025-04-29 | 创建项目计划文档 | 无 | 无 | 开始第一阶段 |

## 10. 附录

### 10.1 参考文档

- 现有系统文档
- 代码库链接
- 相关技术文档

### 10.2 术语表

- **通用奖励确定函数**: `determine_rewards_generic` 函数，基于配置确定奖励类型和名称
- **功能标志**: 用于控制是否使用新实现的配置项
- **包装函数**: 调用通用函数并传入特定参数的函数

### 10.3 代码示例

#### 10.3.1 通用数据处理函数示例

```python
def process_data_generic(
    contract_data, 
    existing_contract_ids, 
    housekeeper_award_lists, 
    config_key,  # 例如 "BJ-2025-04", "SH-2025-04"
    use_generic=True,
    use_combined_key=False  # 是否使用组合键（上海特有）
):
    # 从配置中获取相关参数
    city_code = config_key.split("-")[0]  # 例如 "BJ", "SH"
    
    # 根据城市代码选择相应的配置
    if city_code == "BJ":
        performance_cap = config.PERFORMANCE_AMOUNT_CAP_BJ_FEB
        project_limit = config.SINGLE_PROJECT_CONTRACT_AMOUNT_LIMIT_BJ_FEB
        enable_cap = config.ENABLE_PERFORMANCE_AMOUNT_CAP_BJ_FEB
    else:  # "SH"
        performance_cap = config.PERFORMANCE_AMOUNT_CAP
        project_limit = None  # 上海没有工单金额上限
        enable_cap = config.ENABLE_PERFORMANCE_AMOUNT_CAP
    
    # 初始化数据结构
    performance_data = []
    contract_count_in_activity = len(existing_contract_ids) + 1
    housekeeper_contracts = {}
    processed_contract_ids = set()
    service_appointment_amounts = {}
    
    # 遍历合同数据
    for contract in contract_data:
        # 处理逻辑...
        
    return performance_data
```

#### 10.3.2 并行运行逻辑示例

```python
def process_data_apr_beijing(contract_data, existing_contract_ids, housekeeper_award_lists, use_generic=False):
    # 原始逻辑
    original_result = original_process_logic(...)
    
    if config.USE_GENERIC_PROCESS_FUNCTION:
        # 新逻辑
        new_result = process_data_generic(
            contract_data, 
            existing_contract_ids.copy(),  # 使用副本避免影响原始逻辑
            housekeeper_award_lists, 
            "BJ-2025-04",
            use_generic,
            use_combined_key=False
        )
        
        # 比较结果
        compare_results(original_result, new_result, "BJ-2025-04")
    
    return original_result
```

---

**文档结束**
