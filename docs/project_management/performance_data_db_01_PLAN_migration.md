# 签约台账数据库化项目计划

## 文档信息
**文档类型**: 项目计划
**文档编号**: performance_data_db-PLAN-001
**版本**: 1.3.0
**创建日期**: 2025-05-07
**最后更新**: 2025-05-08
**状态**: 进行中
**负责人**: Frank
**团队成员**: Frank & AI助手

**相关文档**:
- [系统架构概览](../03_system_architecture.md)
- [项目进度报告](./performance_data_db_02_PROGRESS_report.md)
- [测试任务清单](./performance_data_db_03_TASK_testing.md)

## 1. 项目概述

### 1.1 背景

目前，签约台账数据（包含签约数据和奖励活动计算结果）以CSV文件形式存储在`state`目录下，文件名格式为`PerformanceData-{城市}-{月份}.csv`。这种存储方式存在以下问题：

1. 数据查询和分析不便
2. 数据完整性和一致性难以保证
3. 数据处理逻辑分散在多个函数中
4. 不同城市的数据格式略有差异，增加了维护成本

为解决这些问题，计划将签约台账数据从文件存储转为数据库存储，创建统一的表结构，兼容北京和上海的数据格式。

### 1.2 目标

1. 设计并创建一个统一的数据库表结构，兼容北京和上海的签约台账数据
2. 开发数据处理模块，将新的签约数据处理并保存到数据库
3. 开发数据查询功能，支持按城市、时间、管家等条件查询数据
4. 确保新系统与现有系统的兼容性，实现平滑过渡
5. 在确认新系统稳定可靠后，逐步替代旧系统
6. 进行全面的测试，确保数据库存储方式与文件存储方式功能完全等价
7. 特别关注奖励计算逻辑和通知逻辑在两种存储方式下的一致性

### 1.3 范围

#### 包含内容

1. 数据库表设计和创建
2. 数据处理模块开发
3. 数据查询功能开发
4. 新旧系统兼容性保障
5. 测试和验证

#### 不包含内容

1. 现有CSV文件数据导入到数据库（非必要功能）
2. 数据库数据导出为CSV文件（非必要功能）
3. Web界面开发
4. 数据分析功能开发

## 2. 实施计划

### 2.1 阶段一：设计与准备

1. **分析现有CSV文件结构**
   - 详细分析北京和上海的CSV文件结构
   - 确定字段和数据类型
   - 识别共同字段和差异字段

2. **设计数据库表结构**
   - 设计统一的表结构，兼容两个城市的数据
   - 确定主键和索引
   - 设计字段类型和约束

3. **编写数据库表创建脚本**
   - 创建`scripts/create_performance_data_table.py`脚本
   - 实现表创建和索引创建功能

### 2.2 阶段二：基础功能开发

1. **开发数据管理模块**
   - 创建`modules/performance_data_manager.py`模块
   - 实现数据库CRUD操作
   - 实现数据查询功能

2. **开发数据处理模块**
   - 创建`modules/data_processing_db_module.py`模块
   - 实现合同数据处理和保存到数据库的功能
   - 确保兼容北京和上海的数据处理逻辑

### 2.3 阶段三：业务逻辑整合

1. **修改任务调度模块**
   - 修改`jobs.py`中的相关函数
   - 添加使用数据库版本的数据处理模块的选项
   - 确保新旧系统可以并行运行

2. **确保新旧系统兼容性**
   - 添加配置选项，控制是否使用数据库存储
   - 确保现有功能不受影响
   - 实现平滑过渡策略

### 2.4 阶段四：测试与优化

1. **基础功能等价性测试**
   - 创建`tests/test_storage_equivalence.py`脚本
   - 测试文件存储和数据库存储的数据处理结果一致性
   - 验证北京和上海的数据处理结果一致
   - 验证4月和5月的数据处理结果一致

2. **奖励计算逻辑专项测试**
   - 创建`tests/test_reward_calculation.py`脚本
   - 测试幸运数字奖励计算一致性
   - 测试节节高奖励计算一致性
   - 测试奖励阈值判断一致性
   - 测试业绩金额计算一致性
   - 测试奖金池计算一致性

3. **通知逻辑专项测试**
   - 创建`tests/test_notification.py`脚本
   - 测试通知触发条件一致性
   - 测试通知内容生成一致性
   - 测试通知接收人确定一致性
   - 测试通知状态跟踪一致性

4. **性能和边界测试**
   - 测试数据库在大数据量下的性能表现
   - 测试系统在各种边界条件下的行为
   - 与文件操作性能进行比较
   - 优化查询性能

5. **集成测试和回归测试**
   - 测试数据库存储方式与系统其他组件的集成
   - 确保数据库迁移不影响现有功能
   - 验证所有现有功能正常工作

6. **根据测试结果进行优化**
   - 优化数据库结构
   - 优化查询语句
   - 解决发现的问题



## 3. 风险与缓解措施

| 风险 | 可能性 | 影响 | 缓解措施 |
|------|--------|------|----------|
| 新系统与现有系统不兼容 | 中 | 高 | 保留原有文件处理逻辑，确保两套系统可并行运行，直到新系统稳定可靠 |
| 数据库性能问题 | 低 | 中 | 创建适当的索引，优化查询语句 |
| 业务逻辑变更 | 低 | 中 | 设计灵活的数据结构，预留扩展空间 |


## 4. 依赖关系

### 4.1 内部依赖

- SQLite数据库支持
- 现有的数据处理逻辑
- 现有的任务调度系统

### 4.2 外部依赖

- 无

## 5. 资源需求

### 5.1 人力资源

- 开发人员：Frank & AI助手
- 测试人员：Frank

### 5.2 技术资源

- 开发环境：现有开发环境
- 测试环境：现有测试环境
- 生产环境：现有生产环境

## 6. 验收标准

1. 成功创建数据库表，并能正确存储新的签约数据
2. 数据处理模块能够正确处理合同数据并保存到数据库
3. 数据查询功能正常工作，能够按不同条件查询数据
4. 新系统与现有系统兼容，支持平滑过渡
5. 测试脚本全部通过，无错误报告


## 7. 项目时间线

| 里程碑 | 描述 | 计划完成日期 | 实际完成日期 | 状态 |
|--------|------|--------------|--------------|------|
| M1 | 数据库表设计和创建完成 | 2025-05-07 | 2025-05-07 | 已完成 |
| M2 | 数据处理模块开发完成 | 2025-05-07 | 2025-05-07 | 已完成 |
| M3 | 数据查询功能开发完成 | 2025-05-07 | 2025-05-07 | 已完成 |
| M4 | 测试和验证完成 | 2025-05-07 | 2025-05-07 | 已完成 |


## 8. 沟通计划

- 项目进度更新：每周一次
- 问题和风险报告：及时报告
- 代码审查：每个功能模块完成后进行

## 9. 后续计划

1. 优化数据库结构，提高查询效率
2. 开发数据分析功能，提供更多业务洞察
3. 考虑开发Web界面，方便用户查询和管理数据
4. 考虑迁移到更强大的数据库系统，如MySQL或PostgreSQL

## 更新记录

| 版本 | 日期 | 更新者 | 更新内容 |
|------|------|--------|----------|
| 1.0.0 | 2025-05-07 | Frank & AI助手 | 初始版本 |
| 1.1.0 | 2025-05-07 | Frank & AI助手 | 更新项目进度 |
| 1.2.0 | 2025-05-07 | Frank & AI助手 | 添加专项测试计划，包括奖励计算逻辑和通知逻辑的专门测试 |
| 1.3.0 | 2025-05-08 | Frank & AI助手 | 移除部署和监控相关内容，项目规模较小，暂不考虑部署问题 |
