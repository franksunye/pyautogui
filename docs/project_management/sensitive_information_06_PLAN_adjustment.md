# 敏感信息保护计划 - 调整方案

## 文档信息
**文档类型**: 项目计划
**文档编号**: sensitive_information-PLAN-002
**版本**: 1.0.0
**创建日期**: 2025-04-29
**最后更新**: 2025-04-29
**状态**: 草稿
**负责人**: Frank
**团队成员**: Frank, 小智
**优先级**: 高
**预计工期**: 1周

**相关文档**:
- [敏感信息保护计划](./sensitive_information_01_PLAN_protection.md) (sensitive_information-PLAN-001)
- [敏感信息清单](./sensitive_information_00_DOC_inventory.md) (sensitive_information-DOC-001)
- [环境变量结构设计](./sensitive_information_02_DOC_env_var_structure.md) (sensitive_information-DOC-002)
- [敏感信息保护任务清单](./sensitive_information_03_TASK_protection.md) (sensitive_information-TASK-001)
- [敏感信息保护计划 - Sprint回顾](./sensitive_information_04_REVIEW_protection.md) (sensitive_information-REVIEW-001)
- [敏感信息保护计划 - 部署计划](./sensitive_information_05_DEPLOY_plan.md) (sensitive_information-DEPLOY-001)
- [敏感信息保护调整任务清单](./sensitive_information_07_TASK_adjustment.md) (sensitive_information-TASK-002)

## 1. 调整概述

### 1.1 背景

在实施敏感信息保护计划的过程中，我们发现将所有配置项（包括非敏感的）都迁移到环境变量，导致配置管理变得过于复杂。新的配置类使用了单例模式、动态属性获取、类型转换和缓存机制等高级特性，增加了维护难度。这些复杂性可能会影响代码的可维护性和稳定性。

### 1.2 目标

- 保留敏感信息保护的核心目标，继续保护所有敏感信息
- 简化配置管理方案，避免过度工程化
- 明确区分敏感和非敏感配置，只将敏感信息移至环境变量
- 保持原有代码的稳定性，最小化对运行良好代码的改动
- 确保所有功能在调整后正常工作

### 1.3 范围

- 回滚复杂的配置类，保留原有的 `config.py` 文件但进行简化
- 修改配置文件，明确区分敏感和非敏感配置
- 更新环境变量文件，只包含敏感信息
- 更新相关文档，说明新的配置管理方式
- 测试验证所有功能在新配置管理方式下正常工作

### 1.4 非范围

- 不包括对系统功能的扩展或改进
- 不包括对系统架构的重大变更
- 不包括对第三方服务的替换或升级

## 2. 调整方案

### 2.1 保留敏感信息保护的核心目标

继续保护敏感度为"高"的信息（密码、API密钥、Webhook URLs等），将它们从代码中移除，存储在环境变量中。这是专项的核心目标，必须保留。敏感度为"中"的信息（如API端点）可以保留在代码中，进一步简化配置管理。

### 2.2 简化配置管理方案

不再使用复杂的 `Config` 类和动态属性映射机制，而是采用更简单的函数封装方式：

```python
# 简化后的配置管理方案
def get_env(name, default=None, cast=None):
    """获取环境变量，支持默认值和类型转换"""
    value = os.getenv(name, default)
    if value is None:
        return None

    if cast is not None:
        if cast is bool:
            return value.lower() in ('true', 'yes', '1', 'y')
        return cast(value)

    return value

# 敏感信息通过函数获取
def get_metabase_username():
    return get_env('METABASE_USERNAME')

def get_metabase_password():
    return get_env('METABASE_PASSWORD')

# 非敏感配置保留为常量
TASK_CHECK_INTERVAL = 10
ARCHIVE_DIR = 'archive'
```

### 2.3 区分敏感和非敏感配置

明确区分敏感度不同的配置，只将敏感度为"高"的信息移至环境变量：

1. **高敏感度信息**（移至环境变量）：
   - 账号凭据（用户名、密码）
   - API密钥和Webhook URLs
   - 个人信息（电话号码等）

2. **中低敏感度配置**（保留在代码中）：
   - API端点和服务器URL
   - 文件路径和文件名
   - 功能标志和开关
   - 时间间隔和超时设置
   - 业务规则和参数（如奖励配置）

### 2.4 保留环境变量验证机制

继续使用环境变量验证机制，确保所有必需的敏感信息都已正确配置。

### 2.5 保留日志脱敏处理

继续使用日志脱敏处理，确保敏感信息不会被记录在日志中。

## 3. 实施计划

### 3.1 第一阶段: 准备工作 (第1天)
- [ ] **任务1.1**: 审查当前的配置系统
  - 优先级: 高
  - 估计工时: 2小时
  - 描述: 全面审查当前的配置系统，确定需要保留和修改的部分。

- [ ] **任务1.2**: 更新敏感信息清单
  - 优先级: 高
  - 估计工时: 1小时
  - 描述: 更新敏感信息清单，明确区分敏感和非敏感配置。

### 3.2 第二阶段: 配置系统调整 (第2-3天)
- [ ] **任务2.1**: 回滚复杂的配置类
  - 优先级: 高
  - 估计工时: 2小时
  - 描述: 删除 `config_new.py` 文件，回滚到使用原有的 `config.py` 文件。

- [ ] **任务2.2**: 修改 `config.py`
  - 优先级: 高
  - 估计工时: 3小时
  - 描述: 修改 `config.py` 文件，保留敏感信息的获取函数，将非敏感配置恢复为常量。

- [ ] **任务2.3**: 更新环境变量文件
  - 优先级: 高
  - 估计工时: 1小时
  - 描述: 更新 `.env.example` 文件，只包含敏感信息。

### 3.3 第三阶段: 测试与验证 (第4-5天)
- [ ] **任务3.1**: 单元测试
  - 优先级: 高
  - 估计工时: 2小时
  - 描述: 编写和执行单元测试，验证配置系统的功能。

- [ ] **任务3.2**: 功能测试
  - 优先级: 高
  - 估计工时: 3小时
  - 描述: 测试所有功能，确保在新配置管理方式下正常工作。

- [ ] **任务3.3**: 安全测试
  - 优先级: 高
  - 估计工时: 2小时
  - 描述: 验证敏感信息保护措施的有效性，确保敏感信息不会泄露。

### 3.4 第四阶段: 文档与完成 (第6-7天)
- [ ] **任务4.1**: 更新配置指南
  - 优先级: 中
  - 估计工时: 2小时
  - 描述: 更新配置指南，说明新的配置管理方式。

- [ ] **任务4.2**: 更新环境变量结构文档
  - 优先级: 中
  - 估计工时: 1小时
  - 描述: 更新环境变量结构文档，反映新的环境变量使用方式。

- [ ] **任务4.3**: 创建调整总结报告
  - 优先级: 中
  - 估计工时: 2小时
  - 描述: 创建调整总结报告，记录调整过程和结果。

## 4. 测试与验证计划

### 4.1 测试目标

确保敏感信息保护措施在调整后仍然有效，同时验证所有功能在新配置管理方式下正常工作。

### 4.2 测试范围

1. 环境变量加载和验证
2. 敏感信息保护
3. 日志脱敏处理
4. 系统主要功能

### 4.3 关键测试用例

#### 环境变量测试
```python
def test_env_loading():
    # 测试环境变量加载
    self.assertEqual(get_metabase_username(), os.getenv('METABASE_USERNAME'))
    self.assertEqual(get_metabase_password(), os.getenv('METABASE_PASSWORD'))
```

#### 敏感信息保护测试
```python
def test_sensitive_info_protection():
    # 测试敏感信息不会硬编码在代码中
    with open('modules/config.py', 'r') as f:
        content = f.read()
        self.assertNotIn('wangshuang@xlink.bj.cn', content)
        self.assertNotIn('xlink123456', content)
```

#### 日志脱敏测试
```python
def test_log_masking():
    # 测试日志脱敏
    contract_id = 'YHWX-SH-RJTFSGC-2025050001'
    masked = mask_sensitive_info(contract_id)
    self.assertEqual(masked, 'YHWX**********************')
```

#### 功能测试
```python
def test_main_functions():
    # 测试主要功能
    # 运行各个任务，确保正常工作
    run_specific_task('beijing-apr')
    run_specific_task('shanghai-apr')
    # 检查结果
```

## 5. 风险与缓解措施

### 5.1 潜在风险

1. **功能中断**：配置系统调整可能导致某些功能无法正常工作。
   - **缓解措施**：全面测试所有功能，准备回滚计划。

2. **敏感信息泄露**：调整过程中可能意外泄露敏感信息。
   - **缓解措施**：严格审查代码变更，确保敏感信息不会硬编码在代码中。

3. **环境变量配置错误**：环境变量配置错误可能导致系统无法启动。
   - **缓解措施**：提供详细的环境变量配置指南，增强环境变量验证机制。

### 5.2 应急计划

1. 保留原始代码的备份
2. 准备回滚脚本
3. 设置监控和警报机制

## 6. 交付物

1. 更新的 `config.py` 文件
2. 更新的环境变量文件模板
3. 更新的文档，包括配置指南和环境变量结构文档
4. 测试报告和验证结果
5. 调整总结报告

## 7. 验收标准

1. 所有敏感信息都已从代码中移除，存储在环境变量中
2. 配置管理方案简化，避免过度工程化
3. 所有功能在新配置管理方式下正常工作
4. 文档已更新，反映新的配置管理方式

## 8. 项目时间线

| 阶段 | 开始日期 | 结束日期 | 工作内容 |
|------|----------|----------|----------|
| 准备工作 | 2025-05-07 | 2025-05-07 | 审查当前配置系统，更新敏感信息清单 |
| 配置系统调整 | 2025-05-07 | 2025-05-07 | 回滚复杂的配置类，修改 config.py，更新环境变量文件 |
| 测试与验证 | 2025-05-07 | 2025-05-07 | 单元测试，功能测试，安全测试 |
| 文档与完成 | 2025-05-07 | 2025-05-07 | 更新文档，创建调整总结报告 |

## 更新记录

| 版本 | 日期 | 更新者 | 更新内容 |
|------|------|--------|----------|
| 1.0.0 | 2025-04-29 | 小智 | 初始版本 |
