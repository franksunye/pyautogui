# 系统架构文档更新计划

**文档类型**: 项目计划
**文档编号**: documentation-PLAN-001
**版本**: 1.1.0
**创建日期**: 2025-05-15
**最后更新**: 2025-05-16
**状态**: 已完成
**优先级**: 低
**负责人**: Frank
**团队成员**: Frank

**相关文档**:
- [发送状态文件管理机制移除计划](./send_status_01_PLAN_removal.md) (send_status-PLAN-001)
- [系统架构概览](../03_system_architecture.md)

## 1. 计划概述

### 1.1 背景

随着项目消息发送功能的解耦和数据库任务管理系统的实现，系统架构发生了重要变化。当前的系统架构文档（`03_system_architecture.md`）未能反映这些变化，特别是关于消息发送机制从基于文件的状态跟踪转变为基于数据库的任务管理。

### 1.2 目标

1. 更新系统架构文档，准确反映当前的消息发送机制
2. 添加任务管理系统的详细描述
3. 更新数据流和数据存储部分
4. 确保文档与代码保持一致

### 1.3 范围

本计划涉及以下文档：
- `03_system_architecture.md`（主要更新目标）
- `README.md`（可能需要轻微更新）
- `06_configuration_guide.md`（可能需要轻微更新）

## 2. 详细设计

### 2.1 系统架构文档更新

#### 2.1.1 核心组件部分更新
添加或更新以下组件的描述：

- **任务管理系统 (task_manager.py)**
  - 功能：管理消息发送任务的创建和状态更新
  - 关键组件：Task类、数据库交互函数
  - 与其他组件的关系

- **任务调度器 (task_scheduler.py)**
  - 功能：调度和执行任务队列中的任务
  - 关键组件：任务检查循环、任务执行线程
  - 与消息发送模块的集成

#### 2.1.2 数据流部分更新
更新通知发送流程：

```
旧流程：业绩数据CSV文件 -> notification_module.py -> 企业微信API
新流程：业绩数据CSV文件 -> notification_module.py -> task_manager.py -> task_scheduler.py -> message_sender.py -> 企业微信API
```

#### 2.1.3 数据存储部分更新
更新数据存储描述：

- **文件存储**
  - 移除"发送状态：存储在JSON文件中"
  - 保留合同数据和业绩数据的CSV文件存储描述

- **数据库存储**
  - 添加任务表（tasks）的详细描述
  - 说明任务表的结构和用途
  - 说明数据库如何替代了原有的JSON文件状态跟踪

### 2.2 README.md更新

在核心技术栈和系统架构部分添加或更新以下内容：

- 强调SQLite数据库在任务管理中的作用
- 更新任务管理系统和任务调度器的描述

### 2.3 配置指南更新

在配置指南中添加任务管理相关的配置项说明：

- 任务调度器检查间隔（TASK_CHECK_INTERVAL）
- 数据库文件路径和配置

## 3. 实施计划

### 3.1 准备阶段

1. **代码审查**
   - 全面审查任务管理和调度相关代码
   - 确认所有功能和组件关系

2. **文档分析**
   - 分析当前文档中需要更新的部分
   - 确定更新的优先级和顺序

### 3.2 实施阶段

1. **第一步：更新系统架构文档**
   - 更新核心组件部分
   - 更新数据流部分
   - 更新数据存储部分

2. **第二步：更新README.md**
   - 更新核心技术栈部分
   - 更新系统架构部分

3. **第三步：更新配置指南**
   - 添加任务管理相关配置项说明

### 3.3 审查阶段

1. **文档审查**
   - 检查更新后的文档是否准确反映当前系统
   - 确保文档之间的一致性

2. **最终确认**
   - 确认所有更新都已完成
   - 确认文档与代码保持一致

## 4. 任务清单

| 任务ID | 任务描述 | 优先级 | 预计工时 | 依赖任务 |
|--------|---------|--------|---------|---------|
| T001 | 代码审查和分析 | 高 | 1小时 | 无 |
| T002 | 文档分析 | 高 | 1小时 | 无 |
| T003 | 更新系统架构文档的核心组件部分 | 中 | 1小时 | T001, T002 |
| T004 | 更新系统架构文档的数据流部分 | 中 | 0.5小时 | T003 |
| T005 | 更新系统架构文档的数据存储部分 | 中 | 0.5小时 | T004 |
| T006 | 更新README.md | 低 | 0.5小时 | T005 |
| T007 | 更新配置指南 | 低 | 0.5小时 | T005 |
| T008 | 文档审查和最终确认 | 高 | 1小时 | T006, T007 |

## 5. 风险评估

### 5.1 潜在风险

| 风险ID | 风险描述 | 可能性 | 影响 | 缓解策略 |
|--------|---------|--------|------|---------|
| R001 | 文档与代码不一致 | 低 | 中 | 在更新文档前进行全面的代码审查 |
| R002 | 遗漏重要组件或关系 | 中 | 中 | 使用系统化的方法审查所有相关代码 |
| R003 | 文档之间的不一致 | 低 | 低 | 确保同时更新所有相关文档 |

### 5.2 应对措施

- 在更新文档前进行全面的代码审查
- 使用系统化的方法审查所有相关代码
- 确保同时更新所有相关文档

## 6. 成功标准

1. 系统架构文档准确反映当前的消息发送机制
2. 任务管理系统和任务调度器在文档中有详细描述
3. 数据流和数据存储部分与当前实现一致
4. 所有相关文档之间保持一致

## 7. 后续行动

1. 定期审查文档，确保与代码保持同步
2. 在未来的系统变更中同步更新文档
3. 考虑添加更详细的任务管理系统文档

## 更新记录

| 版本 | 日期 | 更新者 | 更新内容 |
|------|------|--------|----------|
| 1.0.0 | 2025-05-15 | Frank | 初始版本 |
| 1.1.0 | 2025-05-16 | Frank | 文档更新已完成，系统架构文档已更新 |
