# 发送状态文件管理机制移除计划

**文档类型**: 项目计划
**文档编号**: send_status-PLAN-001
**版本**: 1.1.0
**创建日期**: 2025-05-15
**最后更新**: 2025-05-16
**状态**: 已完成
**优先级**: 中
**负责人**: Frank
**团队成员**: Frank

**相关文档**:
- [发送状态文件管理机制移除任务清单](./send_status_03_TASK_removal.md) (send_status-TASK-001)

## 1. 计划概述

### 1.1 背景

随着项目消息发送功能的解耦和数据库任务管理系统的实现，原有基于`send_status*.json`文件的消息状态跟踪机制已经变得冗余。当前系统同时使用了文件状态跟踪和数据库任务管理，这种冗余增加了代码复杂性并可能导致不一致性。

### 1.2 目标

1. 移除所有与`send_status*.json`文件相关的代码
2. 确保消息发送功能完全依赖于数据库任务管理系统
3. 简化代码，提高系统可维护性
4. 保持现有功能的完整性和稳定性

### 1.3 范围

本计划涉及以下组件：
- `modules/notification_module.py`中的通知函数
- `modules/file_utils.py`中的状态文件管理函数
- `modules/config.py`中的状态文件路径配置
- 所有使用状态文件的作业函数

## 2. 详细设计

### 2.1 移除的组件

#### 2.1.1 文件工具函数
- `load_send_status()`
- `save_send_status()`
- `update_send_status()`

#### 2.1.2 配置项
- `STATUS_FILENAME_BJ_APR`
- `STATUS_FILENAME_BJ_MAY`
- `STATUS_FILENAME_SH_APR`
- `STATUS_FILENAME_SH_MAY`
- `STATUS_FILENAME_TS`
- `DAILY_SERVICE_REPORT_RECORD_FILE`
- 其他与状态文件相关的配置项

### 2.2 修改的组件

#### 2.2.1 通知函数
修改所有通知函数，移除对状态文件的依赖：
- 移除`load_send_status()`调用
- 移除`update_send_status()`调用
- 保留`create_task()`调用和CSV记录更新

#### 2.2.2 作业函数
更新作业函数，移除对状态文件的引用：
- 移除状态文件路径参数
- 调整通知函数调用

## 3. 实施计划

### 3.1 准备阶段

1. **代码审查**
   - 全面审查所有使用状态文件的代码
   - 确认所有状态检查逻辑是否可以安全移除

2. **测试环境准备**
   - 准备测试数据和测试用例
   - 设置测试环境配置

### 3.2 实施阶段

1. **第一步：更新通知函数**
   - 修改`notify_awards_apr_beijing()`函数
   - 修改`notify_awards_may_beijing()`函数
   - 修改`notify_awards_apr_shanghai()`函数
   - 修改`notify_awards_may_shanghai()`函数
   - 修改`notify_technician_status_changes()`函数
   - 修改`notify_daily_service_report()`函数

2. **第二步：更新配置文件**
   - 移除`modules/config.py`中的状态文件路径配置

3. **第三步：更新作业函数**
   - 修改`signing_and_sales_incentive_apr_beijing()`函数
   - 修改`signing_and_sales_incentive_may_beijing()`函数
   - 修改`signing_and_sales_incentive_apr_shanghai()`函数
   - 修改`signing_and_sales_incentive_may_shanghai()`函数
   - 修改`check_technician_status()`函数
   - 修改`generate_daily_service_report()`函数

4. **第四步：移除文件工具函数**
   - 从`modules/file_utils.py`中移除状态文件相关函数

### 3.3 测试阶段

1. **单元测试**
   - 测试修改后的通知函数
   - 测试修改后的作业函数

2. **集成测试**
   - 测试完整的消息发送流程
   - 验证任务创建和执行

3. **回归测试**
   - 确保所有现有功能正常工作
   - 验证没有引入新的问题

### 3.4 部署阶段

1. **备份**
   - 备份所有状态文件
   - 备份当前代码库

2. **部署**
   - 部署更新后的代码
   - 监控系统运行情况

3. **回滚计划**
   - 准备回滚脚本
   - 定义回滚触发条件

## 4. 任务清单

| 任务ID | 任务描述 | 优先级 | 预计工时 | 依赖任务 |
|--------|---------|--------|---------|---------|
| T001 | 代码审查和分析 | 高 | 2小时 | 无 |
| T002 | 准备测试环境和测试数据 | 高 | 1小时 | T001 |
| T003 | 修改北京地区通知函数 | 中 | 2小时 | T002 |
| T004 | 修改上海地区通知函数 | 中 | 2小时 | T002 |
| T005 | 修改技师状态和日报通知函数 | 中 | 2小时 | T002 |
| T006 | 更新配置文件 | 中 | 1小时 | T003, T004, T005 |
| T007 | 更新作业函数 | 中 | 2小时 | T006 |
| T008 | 移除文件工具函数 | 低 | 1小时 | T007 |
| T009 | 执行单元测试 | 高 | 2小时 | T008 |
| T010 | 执行集成测试 | 高 | 2小时 | T009 |
| T011 | 执行回归测试 | 高 | 2小时 | T010 |
| T012 | 准备部署和回滚计划 | 中 | 1小时 | T011 |
| T013 | 部署到生产环境 | 高 | 1小时 | T012 |
| T014 | 监控和验证 | 高 | 2小时 | T013 |

## 5. 风险评估

### 5.1 潜在风险

| 风险ID | 风险描述 | 可能性 | 影响 | 缓解策略 |
|--------|---------|--------|------|---------|
| R001 | 消息重复发送 | 低 | 高 | 确保CSV记录更新逻辑正确 |
| R002 | 消息漏发 | 低 | 高 | 全面测试所有通知场景 |
| R003 | 系统不稳定 | 低 | 中 | 增量修改并持续测试 |
| R004 | 数据库负载增加 | 低 | 低 | 监控数据库性能 |

### 5.2 应对措施

- 实施前进行全面的代码审查
- 准备详细的回滚计划
- 增量修改并在每个步骤后测试
- 部署后密切监控系统性能和日志

## 6. 成功标准

1. 所有与`send_status*.json`文件相关的代码被成功移除
2. 消息发送功能完全依赖于数据库任务管理系统
3. 所有测试用例通过
4. 系统在生产环境中稳定运行
5. 没有消息重复发送或漏发的情况

## 7. 后续行动

1. 监控系统运行情况
2. 收集用户反馈
3. 根据需要进行进一步优化
4. 更新系统文档，反映新的架构

## 更新记录

| 版本 | 日期 | 更新者 | 更新内容 |
|------|------|--------|----------|
| 1.0.0 | 2025-05-15 | Frank | 初始版本 |
| 1.1.0 | 2025-05-16 | Frank | 计划实施完成，所有任务已成功执行 |

---

**相关文档**:
- [系统架构概览](../03_system_architecture.md)
- [配置指南](../06_configuration_guide.md)
- [敏感信息保护计划](./completed/sensitive_information_01_PLAN_protection.md)
