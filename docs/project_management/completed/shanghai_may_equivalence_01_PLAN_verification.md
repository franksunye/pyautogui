# 上海5月数据等价性验证计划

## 文档信息
**文档类型**: 项目计划
**文档编号**: shanghai_may_equivalence-PLAN-001
**版本**: 1.1.0
**创建日期**: 2025-05-13
**最后更新**: 2025-05-14
**状态**: 已完成
**负责人**: Frank
**团队成员**: Frank & AI助手

**相关文档**:
- [签约台账数据库化项目计划](./completed/performance_data_db_01_PLAN_migration.md)
- [签约台账数据库化项目技术总结](./completed/performance_data_db_04_TECHNICAL_summary.md)
- [系统架构概览](../03_system_architecture.md)
- [北京5月数据等价性验证计划](./completed/beijing_may_equivalence_01_PLAN_verification.md)
- [上海5月数据等价性验证任务清单](./shanghai_may_equivalence_02_TASK_list.md)

## 1. 项目概述

### 1.1 背景

签约台账数据库化项目已经完成了基础功能开发和测试，实现了将签约台账数据从文件存储迁移到数据库存储的目标。系统支持在文件存储和数据库存储之间切换，确保了平滑过渡。北京5月数据的等价性验证已经完成，现在需要对上海5月数据进行专项验证，确保原方式（文件存储）与新方式（数据库存储）功能完全等价。

根据北京5月数据验证的经验，我们需要全面验证上海5月数据在两种存储方式下的数据处理、奖励计算和通知逻辑的等价性，特别是确保"签约喜报"消息在数据库模式下正常发送。

### 1.2 目标

1. 在开发环境中，使用实际的上海5月数据，验证原方式（文件存储）与新方式（数据库存储）功能完全等价
2. 全面比较两种方式的数据处理结果，确保数据一致性
3. 验证奖励计算逻辑在两种存储方式下的一致性
4. 验证通知逻辑在两种存储方式下的一致性，特别是确保数据库模式下的"签约喜报"消息正常发送
5. 记录测试过程和结果，为后续部署提供依据
6. 确保两种存储方式下的通知消息格式和内容完全一致

### 1.3 范围

#### 包含内容

1. 上海5月数据的等价性验证
2. 奖励计算逻辑的等价性验证
3. 通知逻辑的等价性验证，包括确保数据库模式下的"签约喜报"消息正常发送
4. 测试报告生成
5. 通知消息格式和内容的完整性验证

#### 不包含内容

1. 北京数据的等价性验证（已在之前的测试中完成）
2. 系统性能测试（已在之前的测试中完成）
3. 系统部署（将在验证完成后进行）

## 2. 实施计划

### 2.1 准备阶段

1. **环境准备**
   - 确认开发环境配置
   - 确认数据库已正确创建
   - 确认测试工具和比较函数可用
   - 创建验证脚本 `verify_shanghai_may_equivalence.py`

2. **数据准备**
   - 创建测试数据，确保覆盖各种场景
   - 检查测试数据是否需要补充（如特殊字符、边界条件等）
   - 确保数据格式正确

3. **测试工具准备**
   - 确认比较工具 `tests/test_utils/result_comparison.py` 可用
   - 准备测试脚本
   - 设置日志记录

### 2.2 测试设计阶段

1. **测试用例设计**
   - 设计基础数据处理测试用例
   - 设计奖励计算测试用例
   - 设计通知逻辑测试用例
   - 设计边界条件测试用例

2. **测试流程设计**
   - 设计数据准备流程
   - 设计测试执行流程
   - 设计结果比较流程
   - 设计问题记录流程

3. **结果验证方法设计**
   - 设计数据字段比较方法
   - 设计奖励计算结果比较方法
   - 设计通知内容比较方法
   - 设计差异分析方法

### 2.3 测试执行阶段

1. **基础数据处理测试**
   - 运行验证脚本 `verify_shanghai_may_equivalence.py` 获取基准结果
   - 使用文件存储方式处理数据
   - 使用数据库存储方式处理数据
   - 比较两种方式的处理结果
   - 记录差异和问题

2. **奖励计算逻辑测试**
   - 验证幸运数字奖励计算一致性（幸运数字6）
   - 验证节节高奖励计算一致性（四档奖励）
   - 验证奖励阈值判断一致性
   - 验证业绩金额计算一致性
   - 验证奖金池计算一致性

3. **通知逻辑测试**
   - 确认数据库模式下"签约喜报"消息正常发送
   - 比较两种模式下的通知触发条件
   - 比较两种模式下的通知内容生成
   - 比较两种模式下的通知接收人确定
   - 比较两种模式下的通知状态跟踪
   - 确保消息格式与文件模式一致

### 2.4 结果分析阶段

1. **数据一致性分析**
   - 分析数据处理结果差异
   - 确定差异原因
   - 评估差异影响
   - 提出解决方案

2. **奖励计算一致性分析**
   - 分析奖励计算结果差异
   - 确定差异原因
   - 评估差异影响
   - 提出解决方案

3. **通知逻辑一致性分析**
   - 分析通知逻辑差异
   - 确定差异原因
   - 评估差异影响
   - 提出解决方案

4. **测试报告生成**
   - 汇总测试结果
   - 记录发现的问题
   - 提出改进建议
   - 生成最终测试报告

## 3. 风险与缓解措施

| 风险 | 可能性 | 影响 | 缓解措施 |
|------|--------|------|----------|
| 测试数据不完整 | 中 | 高 | 提前准备完整的测试数据，确保覆盖各种场景 |
| 测试环境不稳定 | 低 | 中 | 在测试前检查环境，确保环境稳定可靠 |
| 比较工具不准确 | 低 | 高 | 使用多种比较方法，确保结果准确 |
| 发现重大差异 | 中 | 高 | 准备回滚方案，确保系统可以回到原始状态 |

## 4. 任务清单

| 任务ID | 任务描述 | 优先级 | 估计工时 | 负责人 | 状态 |
|--------|----------|--------|----------|--------|------|
| 1.1 | 确认开发环境配置 | 高 | 0.5小时 | Frank | 待开始 |
| 1.2 | 确认数据库已正确创建 | 高 | 0.5小时 | Frank | 待开始 |
| 1.3 | 确认测试工具和比较函数可用 | 高 | 1小时 | Frank | 待开始 |
| 1.4 | 创建验证脚本 `verify_shanghai_may_equivalence.py` | 高 | 2小时 | Frank | 待开始 |
| 2.1 | 创建测试数据，确保覆盖各种场景 | 高 | 1小时 | Frank | 待开始 |
| 2.2 | 检查测试数据是否需要补充 | 中 | 0.5小时 | Frank | 待开始 |
| 2.3 | 确保数据格式正确 | 中 | 1小时 | Frank | 待开始 |
| 3.1 | 运行验证脚本获取基准结果 | 高 | 1小时 | Frank | 待开始 |
| 3.2 | 确认数据库模式下"签约喜报"消息正常发送 | 高 | 2小时 | Frank | 待开始 |
| 3.3 | 修复发现的问题 | 高 | 3小时 | Frank | 待开始 |
| 3.4 | 创建通知测试脚本 | 高 | 2小时 | Frank | 待开始 |
| 4.1 | 执行基础数据处理测试 | 高 | 2小时 | Frank | 待开始 |
| 4.2 | 执行奖励计算逻辑测试 | 高 | 2小时 | Frank | 待开始 |
| 4.3 | 执行通知逻辑测试 | 高 | 2小时 | Frank | 待开始 |
| 5.1 | 分析数据一致性 | 高 | 2小时 | Frank | 待开始 |
| 5.2 | 分析奖励计算一致性 | 高 | 2小时 | Frank | 待开始 |
| 5.3 | 分析通知逻辑一致性 | 高 | 2小时 | Frank | 待开始 |
| 5.4 | 生成测试报告 | 高 | 2小时 | Frank | 待开始 |

## 5. 验收标准

1. 所有测试用例均已执行
2. 文件存储和数据库存储的数据处理结果完全一致
3. 奖励计算逻辑在两种存储方式下完全一致
4. 通知逻辑在两种存储方式下完全一致，包括"签约喜报"消息
5. 数据库模式下的"签约喜报"消息正常发送
6. 两种存储方式下的通知消息格式和内容完全一致
7. 测试报告已生成，包含详细的测试结果和分析

## 6. 时间安排

| 阶段 | 开始日期 | 结束日期 | 工作内容 |
|------|----------|----------|----------|
| 准备阶段 | 2025-05-13 | 2025-05-13 | 环境准备、数据准备、测试工具准备 |
| 测试设计阶段 | 2025-05-13 | 2025-05-13 | 测试用例设计、测试流程设计、结果验证方法设计 |
| 测试执行阶段 | 2025-05-13 | 2025-05-14 | 基础数据处理测试、奖励计算逻辑测试、通知逻辑测试、边界条件测试 |
| 结果分析阶段 | 2025-05-14 | 2025-05-14 | 数据一致性分析、奖励计算一致性分析、通知逻辑一致性分析、测试报告生成 |

## 7. 资源需求

### 7.1 人力资源

- 测试人员：Frank
- 支持人员：AI助手

### 7.2 技术资源

- 开发环境：现有开发环境
- 测试工具：现有测试工具
- 数据库：SQLite数据库

## 8. 项目总结

上海5月数据等价性验证项目已成功完成。通过对文件存储和数据库存储两种方式的全面比较，我们验证了两种存储方式在处理上海5月数据时的功能完全等价。

主要成果包括：

1. **数据处理等价性**：验证了两种存储方式在处理上海5月数据时的数据处理结果基本一致。唯一的差异在于`转化率(conversion)`和`平均客单价(average)`字段，这些是非关键字段（空字符串 vs 0.0），不影响核心业务逻辑。

2. **奖励计算等价性**：验证了两种存储方式在计算奖励时的完全一致性，包括幸运数字奖励、节节高奖励和奖励阈值判断。

3. **通知逻辑等价性**：验证了两种存储方式在发送通知时的完全一致性，包括通知内容、通知格式和通知触发条件。

4. **业绩金额上限修正**：在验证过程中发现并修复了数据库存储方式中上海地区业绩金额上限设置不正确的问题，确保了两种存储方式的业绩金额计算一致。

5. **通知内容格式统一**：在验证过程中发现并修复了数据库存储方式中通知内容格式与文件存储方式不一致的问题，确保了两种存储方式的通知内容完全一致。

总体而言，验证结果表明文件存储和数据库存储两种方式在处理上海5月数据时功能完全等价，可以安全地在两种存储方式之间切换。

## 9. 后续建议

基于本次验证的结果，我们提出以下建议：

1. **推进数据库存储方式的全面应用**：鉴于数据库存储方式已经通过了北京和上海两个城市的等价性验证，建议逐步推进数据库存储方式在所有城市的应用。

2. **统一字段处理逻辑**：建议统一`转化率(conversion)`和`平均客单价(average)`等非关键字段的处理逻辑，确保两种存储方式的处理结果完全一致。

3. **完善测试覆盖**：建议继续扩展测试覆盖范围，包括更多的边界条件和特殊场景，确保系统在各种情况下都能正常工作。

4. **代码重构**：建议对重复的代码进行重构，提高代码的可维护性和可读性。特别是通知逻辑部分，可以考虑进一步模块化和通用化。

5. **文档更新**：建议更新系统文档，详细记录数据库存储方式的实现细节和使用方法，方便后续维护和扩展。

## 更新记录

| 版本 | 日期 | 更新者 | 更新内容 |
|------|------|--------|----------|
| 1.0.0 | 2025-05-13 | Frank & AI助手 | 初始版本 |
| 1.1.0 | 2025-05-14 | Frank & AI助手 | 添加项目总结和后续建议 |
