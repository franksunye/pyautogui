# 重构任务清单

## 第一阶段: 准备工作

### 任务1: 在config.py中添加上海的配置到REWARD_CONFIGS
- **描述**: 分析现有上海奖励规则，在config.py的REWARD_CONFIGS字典中添加SH-2025-04和SH-2025-05配置
- **验收标准**:
  - 配置项已添加
  - 配置与现有上海奖励规则一致
  - 单元测试通过
- **估计工时**: 2小时
- **优先级**: 高
- **状态**: 已完成
- **负责人**: AI助手
- **笔记**:
  - 添加了SH-2025-04和SH-2025-05配置
  - 将PERFORMANCE_AMOUNT_CAP和ENABLE_PERFORMANCE_AMOUNT_CAP变量移至文件顶部，以解决变量未定义的问题
  - 在原始变量位置添加了注释，说明变量已移至文件顶部

### 任务2: 创建determine_rewards_apr_shanghai_generic函数
- **描述**: 实现determine_rewards_apr_shanghai_generic函数，调用通用函数并传入SH-2025-04配置键
- **验收标准**:
  - 函数已实现
  - 函数正确调用determine_rewards_generic
  - 单元测试通过
- **估计工时**: 1小时
- **优先级**: 高
- **状态**: 已完成
- **负责人**: AI助手
- **笔记**:
  - 函数已实现，参照determine_rewards_apr_beijing_generic函数的模式
  - 函数正确调用determine_rewards_generic并传入"SH-2025-04"配置键
  - 添加了适当的文档字符串

### 任务3: 创建determine_rewards_may_shanghai_generic函数
- **描述**: 实现determine_rewards_may_shanghai_generic函数，调用通用函数并传入SH-2025-05配置键
- **验收标准**:
  - 函数已实现
  - 函数正确调用determine_rewards_generic
  - 单元测试通过
- **估计工时**: 1小时
- **优先级**: 高
- **状态**: 已完成
- **负责人**: AI助手
- **笔记**:
  - 函数已实现，参照determine_rewards_apr_shanghai_generic函数的模式
  - 函数正确调用determine_rewards_generic并传入"SH-2025-05"配置键
  - 添加了适当的文档字符串

### 任务4: 为新函数添加单元测试
- **描述**: 为determine_rewards_apr_shanghai_generic和determine_rewards_may_shanghai_generic函数添加单元测试
- **验收标准**:
  - 测试覆盖所有主要场景
  - 测试验证函数行为与原始函数一致
  - 所有测试通过
- **估计工时**: 3小时
- **优先级**: 高
- **状态**: 已完成
- **负责人**: AI助手
- **笔记**:
  - 添加了测试上海4月和5月奖励函数的测试方法
  - 测试了幸运数字和节节高奖励同时获得的场景
  - 测试了上海四档奖励的场景（基础奖、达标奖、优秀奖、精英奖）
  - 修复了测试断言以适应上海的四档奖励结构
  - 添加了更多全面的测试场景：
    - 合同数量边界条件测试
    - 无效输入测试
    - 多级奖励自动发放测试
    - 幸运数字边界测试
    - 性能金额上限测试
  - 所有测试都通过

## 第二阶段: 实现通用数据处理函数

### 任务5: 创建通用数据处理函数
- **描述**: 实现process_data_generic函数，支持所有现有功能
- **验收标准**:
  - 函数已实现
  - 函数能处理北京和上海的所有差异
  - 单元测试通过
- **估计工时**: 6小时
- **优先级**: 高
- **状态**: 待办
- **负责人**:
- **笔记**:

### 任务6: 添加功能标志
- **描述**: 在config.py中添加功能标志USE_GENERIC_PROCESS_FUNCTION
- **验收标准**:
  - 功能标志已添加
  - 默认值设为False
  - 文档已更新
- **估计工时**: 0.5小时
- **优先级**: 中
- **状态**: 待办
- **负责人**:
- **笔记**:

### 任务7: 创建包装函数
- **描述**: 实现process_data_apr_beijing_generic和process_data_shanghai_apr_generic
- **验收标准**:
  - 函数已实现
  - 函数正确调用process_data_generic
  - 单元测试通过
- **估计工时**: 2小时
- **优先级**: 高
- **状态**: 待办
- **负责人**:
- **笔记**:

## 第三阶段: 并行运行和验证

### 任务8: 修改现有的处理函数
- **描述**: 在process_data_apr_beijing和process_data_shanghai_apr中添加并行运行逻辑
- **验收标准**:
  - 修改已完成
  - 函数根据功能标志决定是否并行运行
  - 原始功能不受影响
- **估计工时**: 3小时
- **优先级**: 高
- **状态**: 待办
- **负责人**:
- **笔记**:

### 任务9: 添加结果比较函数
- **描述**: 实现compare_results函数，详细比较两种方法的结果
- **验收标准**:
  - 函数已实现
  - 函数能检测并记录任何差异
  - 日志格式清晰易读
- **估计工时**: 2小时
- **优先级**: 中
- **状态**: 待办
- **负责人**:
- **笔记**:

### 任务10: 在测试环境中启用功能标志
- **描述**: 在测试环境中设置USE_GENERIC_PROCESS_FUNCTION = True
- **验收标准**:
  - 功能标志已启用
  - 并行运行正常工作
  - 比较结果无差异或差异已解决
- **估计工时**: 1小时
- **优先级**: 中
- **状态**: 待办
- **负责人**:
- **笔记**:

## 第四阶段: 切换到新实现

### 任务11: 修改包装函数
- **描述**: 更新process_data_apr_beijing和process_data_shanghai_apr以使用新逻辑
- **验收标准**:
  - 修改已完成
  - 函数根据功能标志选择使用新逻辑或原始逻辑
  - 单元测试通过
- **估计工时**: 2小时
- **优先级**: 高
- **状态**: 待办
- **负责人**:
- **笔记**:

### 任务12: 在生产环境中启用功能标志
- **描述**: 在生产环境中设置USE_GENERIC_PROCESS_FUNCTION = True
- **验收标准**:
  - 功能标志已启用
  - 系统运行正常
  - 没有新的错误或警告
- **估计工时**: 1小时
- **优先级**: 高
- **状态**: 待办
- **负责人**:
- **笔记**:

### 任务13: 添加监控和警报
- **描述**: 实现监控机制，设置警报
- **验收标准**:
  - 监控已实现
  - 警报已设置
  - 测试触发警报成功
- **估计工时**: 3小时
- **优先级**: 中
- **状态**: 待办
- **负责人**:
- **笔记**:

## 第五阶段: 清理和完成

### 任务14: 移除原始实现
- **描述**: 一旦确认新实现稳定可靠，移除原始逻辑
- **验收标准**:
  - 原始逻辑已移除
  - 保留包装函数
  - 系统运行正常
- **估计工时**: 2小时
- **优先级**: 低
- **状态**: 待办
- **负责人**:
- **笔记**:

### 任务15: 移除功能标志
- **描述**: 移除USE_GENERIC_PROCESS_FUNCTION标志
- **验收标准**:
  - 功能标志已移除
  - 直接使用新实现
  - 系统运行正常
- **估计工时**: 0.5小时
- **优先级**: 低
- **状态**: 待办
- **负责人**:
- **笔记**:

### 任务16: 更新文档
- **描述**: 更新所有相关文档
- **验收标准**:
  - 文档已更新
  - 文档反映新的实现
  - 提供迁移指南
- **估计工时**: 2小时
- **优先级**: 中
- **状态**: 待办
- **负责人**:
- **笔记**:

### 任务17: 代码审查和最终测试
- **描述**: 进行全面的代码审查和测试
- **验收标准**:
  - 代码审查已完成
  - 所有测试通过
  - 没有新的错误或警告
- **估计工时**: 4小时
- **优先级**: 高
- **状态**: 待办
- **负责人**:
- **笔记**:
