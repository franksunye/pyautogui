# 奖励系统重构任务清单

## 文档信息
**文档类型**: 任务清单
**文档编号**: reward_system-TASK-001
**版本**: 1.3.0
**创建日期**: 2025-04-29
**最后更新**: 2025-05-17
**状态**: 活动
**关联计划**: reward_system-PLAN-001

**相关文档**:
- [奖励系统重构计划](./reward_system_01_PLAN_refactoring.md) (reward_system-PLAN-001)
- [奖励系统重构Scrum任务板](./reward_system_02_BOARD_sprint1.md) (reward_system-BOARD-001)

## 第一阶段: 准备工作

### 任务1: 在config.py中添加上海的配置到REWARD_CONFIGS
- **描述**: 分析现有上海奖励规则，在config.py的REWARD_CONFIGS字典中添加SH-2025-04和SH-2025-05配置
- **验收标准**:
  - 配置项已添加
  - 配置与现有上海奖励规则一致
  - 单元测试通过
- **估计工时**: 2小时
- **优先级**: 高
- **状态**: 已完成
- **负责人**: 小智
- **团队成员**: Frank, 小智
- **笔记**:
  - 添加了SH-2025-04和SH-2025-05配置
  - 将PERFORMANCE_AMOUNT_CAP和ENABLE_PERFORMANCE_AMOUNT_CAP变量移至文件顶部，以解决变量未定义的问题
  - 在原始变量位置添加了注释，说明变量已移至文件顶部

### 任务2: 创建determine_rewards_apr_shanghai_generic函数
- **描述**: 实现determine_rewards_apr_shanghai_generic函数，调用通用函数并传入SH-2025-04配置键
- **验收标准**:
  - 函数已实现
  - 函数正确调用determine_rewards_generic
  - 单元测试通过
- **估计工时**: 1小时
- **优先级**: 高
- **状态**: 已完成
- **负责人**: 小智
- **团队成员**: Frank, 小智
- **笔记**:
  - 函数已实现，参照determine_rewards_apr_beijing_generic函数的模式
  - 函数正确调用determine_rewards_generic并传入"SH-2025-04"配置键
  - 添加了适当的文档字符串

### 任务3: 创建determine_rewards_may_shanghai_generic函数
- **描述**: 实现determine_rewards_may_shanghai_generic函数，调用通用函数并传入SH-2025-05配置键
- **验收标准**:
  - 函数已实现
  - 函数正确调用determine_rewards_generic
  - 单元测试通过
- **估计工时**: 1小时
- **优先级**: 高
- **状态**: 已完成
- **负责人**: 小智
- **团队成员**: Frank, 小智
- **笔记**:
  - 函数已实现，参照determine_rewards_apr_shanghai_generic函数的模式
  - 函数正确调用determine_rewards_generic并传入"SH-2025-05"配置键
  - 添加了适当的文档字符串

### 任务4: 为新函数添加单元测试
- **描述**: 为determine_rewards_apr_shanghai_generic和determine_rewards_may_shanghai_generic函数添加单元测试
- **验收标准**:
  - 测试覆盖所有主要场景
  - 测试验证函数行为与原始函数一致
  - 所有测试通过
- **估计工时**: 3小时
- **优先级**: 高
- **状态**: 已完成
- **负责人**: 小智
- **团队成员**: Frank, 小智
- **笔记**:
  - 添加了测试上海4月和5月奖励函数的测试方法
  - 测试了幸运数字和节节高奖励同时获得的场景
  - 测试了上海四档奖励的场景（基础奖、达标奖、优秀奖、精英奖）
  - 修复了测试断言以适应上海的四档奖励结构
  - 添加了更多全面的测试场景：
    - 合同数量边界条件测试
    - 无效输入测试
    - 多级奖励自动发放测试
    - 幸运数字边界测试
    - 性能金额上限测试
  - 所有测试都通过

## 第二阶段: 创建独立的奖励计算模块

### 任务5: 创建奖励计算模块
- **描述**: 创建reward_calculation.py模块，将所有奖励计算函数移至该模块
- **验收标准**:
  - 模块已创建
  - 所有奖励计算函数已移至该模块
  - 函数接口保持一致
  - 所有函数都有清晰的文档
  - 单元测试通过
- **估计工时**: 4小时
- **优先级**: 高
- **状态**: 已完成
- **负责人**: 小智
- **笔记**:
  - 创建了新的reward_calculation.py模块
  - 将所有奖励计算函数从data_processing_module.py移至该模块
  - 保持了函数接口的一致性
  - 添加了详细的文档和注释

### 任务6: 确保函数接口简单明了
- **描述**: 审查奖励计算函数接口，确保简单明了
- **验收标准**:
  - 函数接口已审查
  - 所有函数都有清晰的文档
  - 代码简洁易懂
  - 没有不必要的抽象层
- **估计工时**: 2小时
- **优先级**: 高
- **状态**: 已完成
- **负责人**: 小智
- **笔记**:
  - 审查了奖励计算模块中的所有函数接口
  - 添加了更详细的模块级别文档，包括模块结构和使用方法
  - 为每个函数添加了更详细的参数和返回值说明
  - 统一了所有函数的文档格式和内容

### 任务7: 修改数据库处理模块
- **描述**: 更新data_processing_db_module.py，使用新的奖励计算模块而非直接导入文件处理模块
- **验收标准**:
  - 修改已完成
  - 直接从奖励计算模块导入所需函数
  - 使用简单条件判断选择合适的奖励计算函数
  - 没有直接导入文件处理模块
  - 代码简洁明了
  - 功能与原始实现一致
  - 单元测试通过
- **估计工时**: 3小时
- **优先级**: 高
- **状态**: 已完成
- **负责人**: 小智
- **笔记**:
  - 更新了data_processing_db_module.py，使其直接从奖励计算模块导入函数
  - 创建了REWARD_CALCULATOR_MAP字典，将活动ID映射到对应的奖励计算函数
  - 简化了process_data_to_db函数中的奖励计算部分，使用映射替代冗长的条件判断
  - 移除了无用的check_lucky_number函数和相关代码
  - 为所有函数添加了更详细的文档

### 任务8: 为奖励计算模块添加单元测试
- **描述**: 为新模块和修改的模块添加单元测试
- **验收标准**:
  - 测试已实现
  - 测试覆盖所有函数
  - 测试覆盖率高
  - 边界情况都有测试
  - 所有测试通过
- **估计工时**: 4小时
- **优先级**: 高
- **状态**: 已完成
- **负责人**: 小智
- **笔记**:
  - 创建了新的测试类TestRewardCalculationModule，专门测试新的奖励计算模块
  - 添加了多个测试用例，覆盖各种场景和边界条件
  - 测试了通用奖励确定函数处理不存在的配置键、缺少字段的管家数据、没有幸运数字的配置、没有节节高奖励的配置等情况
  - 添加了比较原始奖励计算函数和通用奖励计算函数的测试用例
  - 修复了奖励计算模块中的问题，确保与原始实现一致
  - 所有测试都通过

## 第三阶段: 实现通用数据处理函数

### 任务5: 创建通用数据处理函数
- **描述**: 实现process_data_generic函数，支持所有现有功能和两种存储方式
- **验收标准**:
  - 函数已实现
  - 函数能处理北京和上海的所有差异
  - 函数支持文件存储和数据库存储两种模式
  - 函数正确调用determine_rewards_generic进行奖励计算
  - 单元测试通过
- **估计工时**: 8小时
- **优先级**: 高
- **状态**: 待办
- **负责人**:
- **笔记**:

### 任务6: 添加功能标志
- **描述**: 在config.py中添加功能标志USE_GENERIC_PROCESS_FUNCTION
- **验收标准**:
  - 功能标志已添加
  - 默认值设为False
  - 文档已更新
- **估计工时**: 0.5小时
- **优先级**: 中
- **状态**: 待办
- **负责人**:
- **笔记**:

### 任务7: 创建包装函数
- **描述**: 实现process_data_apr_beijing_generic和process_data_shanghai_apr_generic，支持两种存储方式
- **验收标准**:
  - 函数已实现
  - 函数正确调用process_data_generic
  - 函数支持文件存储和数据库存储两种模式
  - 函数与数据库处理函数（如process_beijing_data_to_db）功能等价
  - 单元测试通过
- **估计工时**: 3小时
- **优先级**: 高
- **状态**: 待办
- **负责人**:
- **笔记**:

## 第三阶段: 并行运行和验证

### 任务8: 修改现有的处理函数
- **描述**: 在process_data_apr_beijing和process_data_shanghai_apr中添加并行运行逻辑，支持两种存储方式
- **验收标准**:
  - 修改已完成
  - 函数根据功能标志决定是否并行运行
  - 函数根据USE_DATABASE_FOR_PERFORMANCE_DATA决定存储方式
  - 原始功能不受影响
  - 能够正确比较文件和数据库两种模式的结果
- **估计工时**: 4小时
- **优先级**: 高
- **状态**: 待办
- **负责人**:
- **笔记**:

### 任务9: 添加结果比较函数
- **描述**: 实现compare_results函数和convert_db_result_to_file_format函数，详细比较两种方法的结果
- **验收标准**:
  - 函数已实现
  - compare_results函数能检测并记录任何差异
  - convert_db_result_to_file_format函数能将数据库结果转换为与文件格式相同的格式
  - 能够正确比较文件和数据库两种模式的结果
  - 日志格式清晰易读
- **估计工时**: 3小时
- **优先级**: 中
- **状态**: 待办
- **负责人**:
- **笔记**:

### 任务10: 在测试环境中启用功能标志
- **描述**: 在测试环境中设置USE_GENERIC_PROCESS_FUNCTION = True
- **验收标准**:
  - 功能标志已启用
  - 并行运行正常工作
  - 比较结果无差异或差异已解决
- **估计工时**: 1小时
- **优先级**: 中
- **状态**: 待办
- **负责人**:
- **笔记**:

## 第四阶段: 切换到新实现

### 任务11: 修改包装函数
- **描述**: 更新process_data_apr_beijing和process_data_shanghai_apr以使用新逻辑
- **验收标准**:
  - 修改已完成
  - 函数根据功能标志选择使用新逻辑或原始逻辑
  - 单元测试通过
- **估计工时**: 2小时
- **优先级**: 高
- **状态**: 待办
- **负责人**:
- **笔记**:

### 任务12: 在生产环境中启用功能标志
- **描述**: 在生产环境中设置USE_GENERIC_PROCESS_FUNCTION = True
- **验收标准**:
  - 功能标志已启用
  - 系统运行正常
  - 没有新的错误或警告
- **估计工时**: 1小时
- **优先级**: 高
- **状态**: 待办
- **负责人**:
- **笔记**:

### 任务13: 添加监控和警报
- **描述**: 实现监控机制，设置警报
- **验收标准**:
  - 监控已实现
  - 警报已设置
  - 测试触发警报成功
- **估计工时**: 3小时
- **优先级**: 中
- **状态**: 待办
- **负责人**:
- **笔记**:

## 第五阶段: 清理和完成

### 任务14: 移除原始实现
- **描述**: 一旦确认新实现稳定可靠，移除原始逻辑
- **验收标准**:
  - 原始逻辑已移除
  - 保留包装函数
  - 系统运行正常
- **估计工时**: 2小时
- **优先级**: 低
- **状态**: 待办
- **负责人**:
- **笔记**:

### 任务15: 移除功能标志
- **描述**: 移除USE_GENERIC_PROCESS_FUNCTION标志
- **验收标准**:
  - 功能标志已移除
  - 直接使用新实现
  - 系统运行正常
- **估计工时**: 0.5小时
- **优先级**: 低
- **状态**: 待办
- **负责人**:
- **笔记**:

### 任务16: 更新文档
- **描述**: 更新所有相关文档
- **验收标准**:
  - 文档已更新
  - 文档反映新的实现
  - 提供迁移指南
- **估计工时**: 2小时
- **优先级**: 中
- **状态**: 待办
- **负责人**:
- **笔记**:

### 任务17: 代码审查和最终测试
- **描述**: 进行全面的代码审查和测试
- **验收标准**:
  - 代码审查已完成
  - 所有测试通过
  - 没有新的错误或警告
- **估计工时**: 4小时
- **优先级**: 高
- **状态**: 待办
- **负责人**:
- **笔记**:

## 更新记录

| 版本 | 日期 | 更新者 | 更新内容 |
|------|------|--------|----------|
| 1.0.0 | 2025-04-29 | 小智 | 初始版本 |
| 1.1.0 | 2025-05-15 | Frank | 更新任务以反映数据库存储支持需求；调整工时估计；添加更详细的验收标准 |
| 1.2.0 | 2025-05-16 | Frank | 简化设计，移除工厂模式；更新任务6和任务7以使用简单条件判断；遵循"保持简洁，保持敏捷，避免过度工程化"的原则 |
| 1.3.0 | 2025-05-17 | 小智 | 更新第二阶段任务状态为已完成；添加任务完成的详细笔记；更新文档版本和日期 |